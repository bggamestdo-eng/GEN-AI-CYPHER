<!-- Admin.html ‚Äî updated to be more resilient with backend responses while preserving original logic -->
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì Payment Approval</title>
<style>
  body { font-family: 'Prompt', sans-serif; background: #eef2f7; padding: 20px; }
  .controls { margin-bottom:12px; display:flex; gap:8px; align-items:center; }
  select, input, textarea { padding:6px 8px; border-radius:6px; border:1px solid #ccc; }
  table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; }
  th, td { padding:12px; border-bottom:1px solid #ddd; text-align:left; vertical-align:middle; }
  th { background:#4a76ff; color:white; }
  .btn-approve { padding:6px 8px; background:#28c76f; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:6px;}
  .btn-failed { padding:6px 8px; background:#ff6b6b; color:white; border:none; border-radius:6px; cursor:pointer; }
  .btn-finish { padding:6px 8px; background:gray; color:white; border:none; border-radius:6px; cursor:not-allowed; }
  img.thumb { width:120px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer; }
  .small { max-width:140px; word-break:break-word; font-size:13px; color:#333; }
  a.link { color:#4a76ff; cursor:pointer; text-decoration:underline; }
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999; }
  .modalBox { background:white; padding:16px; border-radius:12px; width:520px; max-height:80vh; overflow:auto; }
  .modalBox textarea { width:100%; height:120px; }
  .threadItem { border-bottom:1px solid #eee; padding:8px 0; }
  .threadAttachments img { width:100px; height:70px; object-fit:cover; margin-right:6px; border-radius:6px; }

  /* ========== Board Contest styles ========== */
  .boardSection { margin-top:28px; background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.04); }
  .field { margin-bottom:10px; }
  .feeButtons { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .feeButtons button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; cursor:pointer; background:#fafafa; }
  .feeButtons button.active { background:#4a76ff; color:white; border-color:#4a76ff; }
  .smallMuted { color:#666; font-size:13px; }
  .previewBox { border-radius:12px; padding:16px; min-height:180px; margin-top:12px; position:relative; overflow:hidden; background-size:cover; background-position:center; }
  .previewOverlay { background:rgba(255,255,255,0.85); padding:12px; border-radius:8px; max-width:420px; }
  .row { display:flex; gap:8px; align-items:center; }
  .col { flex:1; }
  .btn-primary { padding:8px 12px; background:#4a76ff; color:white; border:none; border-radius:8px; cursor:pointer; }
  .btn-ghost { padding:8px 12px; background:#fff; color:#333; border:1px solid #ccc; border-radius:8px; cursor:pointer; }

  /* --- START: tab CSS (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô <style> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) --- */
.tabs { display:flex; gap:10px; margin:16px 0; }
.tab {
  padding:8px 14px;
  background:#e3e7ee;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.tab.active { background:#4a76ff; color:#fff; }
.page { display:none; }
.page.active { display:block; }
/* --- END: tab CSS --- */
  .metaSmall { font-size:13px; color:#444; margin-top:6px; }
</style>
</head>
<body>


<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>

<div class="controls">
  <label>Filter ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
    <select id="statusFilter">
      <option value="all">All</option>
      <option value="pending">Pending</option>
      <option value="approved">Approved</option>
      <option value="failed">Failed</option>
    </select>
  </label>
  <button id="refreshBtn">Refresh</button>
  <button onclick="goBack()">Verify information</button>
  <button onclick="showContent()">Board Contest</button>
    
  <div style="flex:1"></div>
</div>

<table>
  <thead>
    <tr>
      <th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Email</th><th>Concept</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏á‡∏≤‡∏ô</th>
      <th>‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</th><th>‡∏™‡∏•‡∏¥‡∏õ</th><th>Fee</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
    </tr>
  </thead>
  <tbody id="paymentTable"></tbody>
</table>

<!-- Fail modal -->
<div id="failModal" class="modal">
  <div class="modalBox">
    <h3>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
    <div>Payment ID: <span id="failPaymentId"></span></div>
    <textarea id="failReason" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö artist..."></textarea>
    <div style="margin-top:10px; text-align:right;">
      <button id="cancelFail">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="confirmFail" style="background:#ff6b6b;color:white;border:none;padding:8px 12px;border-radius:6px;">‡∏™‡πà‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡∏∞ Failed</button>
    </div>
  </div>
</div>

<!-- Thread popup -->
<div id="threadModal" class="modal">
  <div class="modalBox">
    <h3>Thread / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
    <div id="threadContent"></div>
    <div style="text-align:right;margin-top:8px;">
      <button id="closeThread">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<!-- ========== Board Contest Section ========== -->
<div class="boardSection" id="boardSection">
  <h3>Board Contest</h3>

  <div class="field">
    <label>Concept ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î</label><br>
    <textarea id="bc_concept" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå concept ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î..." rows="2"></textarea>
  </div>

  <div class="field">
    <label>‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
    <div class="feeButtons" id="feeButtons">
      <button data-val="50">50</button>
      <button data-val="100">100</button>
      <button data-val="150">150</button>
      <button data-val="200">200</button>
      <button data-val="300">300</button>
      <button data-val="500">500</button>
    </div>
    <div class="smallMuted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</div>
  </div>



  <div class="field row">
    <div class="col">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 1 Dec 2025)</label><br>
      <input id="bc_open_from" placeholder="1 Dec 2025" />
    </div>
    <div class="col">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label><br>
      <input id="bc_open_to" placeholder="20 Dec 2025" />
    </div>
  </div>

  <div class="field row">
    <div class="col">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï (‡∏à‡∏≤‡∏Å)</label><br>
      <input id="bc_vote_from" placeholder="20 Dec 2025" />
    </div>
    <div class="col">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï (‡∏ñ‡∏∂‡∏á)</label><br>
      <input id="bc_vote_to" placeholder="30 Dec 2025" />
    </div>
  </div>

  <div class="field row">
    <div class="col">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•</label><br>
      <input id="bc_result_date" placeholder="31 Dec 2025" />
    </div>
    <div style="width:220px">
      <label>Background (‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ)</label><br>
      <input type="file" id="bc_bg_input" accept="image/*" />
    </div>
  </div>

  <div class="field">
    <div class="row">
      <button id="generateSample" class="btn-ghost">Generate sample</button>
      <button id="createBoard" class="btn-primary">Create board</button>
    </div>
    <div class="metaSmall">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Generate sample ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå preview ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ background ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á)</div>
  </div>

  <div id="bc_preview" class="previewBox" style="display:none;">
    <div class="previewOverlay" id="bc_preview_overlay">
      <!-- content injected by JS -->
    </div>
  </div>
</div>
<!-- Boards list table (admin) -->
<h3 id="boardTitle" style="margin-top:20px;">Boards (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≠‡∏£‡πå‡∏î)</h3>

<table style="width:100%;background:white;border-radius:10px;overflow:hidden;">
  <thead>
    <tr>
      <th>Concept</th><th>Fee</th><th>Prize</th><th>Contestants</th>
      <th>Open</th><th>Vote</th><th>Result</th><th>Created At</th><th>Action</th>
    </tr>
  </thead>
  <tbody id="boardsTable"></tbody>
</table>
<!-- ====== Open Vote controls + OpenVoteTable (‡πÄ‡∏û‡∏¥‡πà‡∏°) ====== -->
<div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
  <button id="openVoteBtn" class="btn-primary">Open Vote All</button>
  <button id="closeVoteBtn" class="btn-ghost" style="display:none;">Close Vote</button>
  <div style="flex:1"></div>
  <div class="smallMuted">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Open Vote</div>
</div>

<h3 id="openVoteTitle" style="margin-top:14px; display:none;">Open Vote (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏ß‡∏ï)</h3>
<table id="openVoteTable" style="width:100%;background:white;border-radius:10px;overflow:hidden;display:none;">
  <thead>
    <tr>
      <th>Concept</th><th>Fee</th><th>Prize</th><th>Contestants</th>
      <th>Open</th><th>Vote</th><th>Result</th><th>Created At</th><th>Action</th>
    </tr>
  </thead>
  <tbody id="openVoteTableBody"></tbody>
</table>
<!-- ====== end Open Vote block ====== -->
<div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
  <button id="openVoteBtn" class="btn-primary">Open Vote All</button>
  <button id="closeVoteBtn" class="btn-ghost" style="display:none;">Close Vote</button>

  <!-- ‡∏õ‡∏∏‡πà‡∏° Collect votes -->
  <button id="collectVotesBtn" class="btn-primary" style="margin-left:8px;background:#ff8c00;">Collect votes</button>

  <div style="flex:1"></div>
  <div class="smallMuted">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Open Vote ‚Äî ‡∏´‡∏£‡∏∑‡∏≠ Collect results ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ú‡∏•‡πÑ‡∏õ Gallery</div>
</div>

<h3 id="openVoteTitle" style="margin-top:14px; display:none;">Open Vote (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏ß‡∏ï)</h3>
<table id="openVoteTable" style="width:100%;background:white;border-radius:10px;overflow:hidden;display:none;">
  <thead>
    <tr>
      <th>Concept</th><th>Fee</th><th>Prize</th><th>Contestants</th>
      <th>Open</th><th>Vote</th><th>Result</th><th>Created At</th><th>Action</th>
    </tr>
  </thead>
  <tbody id="openVoteTableBody"></tbody>
</table>

<!-- Gallery Table (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Collect votes) -->
<h3 id="galleryTitle" style="margin-top:18px; display:none;">Gallery (‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï)</h3>

<div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
  <label>Filter: <input id="galleryFilter" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (user, email, concept, artwork...)" style="padding:6px; width:320px;"></label>
  <div style="flex:1"></div>
  <div class="smallMuted">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà Collect ‡πÅ‡∏•‡πâ‡∏ß</div>
</div>

<table id="galleryTable" style="width:100%;background:white;border-radius:10px;overflow:hidden;">
<thead>
  <tr>
    <th>user_id</th><th>Email</th><th>Name</th><th>Art</th><th>Concept</th>
    <th>Fee</th><th>Artwork</th><th>Slip</th>
    <th>Confirmed At</th><th>Count Votes</th><th>Winner</th>
    <!-- NEW -->
    <th>Prize money</th><th>Bank info</th><th>‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
    <th>Action</th>
  </tr>
</thead>

  <tbody id="galleryTableBody"></tbody>
</table>
<!-- Admin: Bank info modal -->
<div id="bankInfoModal" class="modal">
  <div class="modalBox" style="width:420px;">
    <h3>Bank information</h3>
    <div id="bankInfoContent"></div>
    <div style="text-align:right;margin-top:10px;">
      <button onclick="document.getElementById('bankInfoModal').style.display='none'">Close</button>
    </div>
  </div>
</div>

<!-- Admin: Attach evidence modal -->
<div id="attachEvidenceModal" class="modal">
  <div class="modalBox">
    <h3>Attach Evidence</h3>
    <input type="file" id="evidenceFileInput" accept="image/*"><br>
    <input type="hidden" id="evidencePaymentId">
    <div style="text-align:right;margin-top:10px;">
      <button onclick="document.getElementById('attachEvidenceModal').style.display='none'">Cancel</button>
      <button onclick="uploadEvidenceForPayment()" class="btn-primary">Upload</button>
    </div>
  </div>
</div>

<script>
  
const API_BASE = "http://gen-ai-cypher.onrender.com";
const paymentTable = document.getElementById("paymentTable");
const statusFilter = document.getElementById("statusFilter");
const refreshBtn = document.getElementById("refreshBtn");

let currentPayments = [];

/* ========== existing admin code (unchanged logic) ========== */
// escape HTML


function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replace(/[&<>\"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  }[m]));
}


/* ‡πÇ‡∏´‡∏•‡∏î pendingPayments (‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å status) */
async function loadPendingPayments() {
  try {
    const res = await fetch(`${API_BASE}/admin/pendingPayments`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    // backend may return array directly or object like { success:true, data: [...] }
    let payments = [];
    if (Array.isArray(data)) payments = data;
    else if (data && Array.isArray(data.data)) payments = data.data;
    else if (data && Array.isArray(data.payments)) payments = data.payments;
    else if (data && data.success && Array.isArray(data.result)) payments = data.result;
    else if (data && data.success && Array.isArray(data.threads)) payments = data.threads; // fallback not likely
    else if (data && typeof data === 'object' && Object.keys(data).length) {
      // if it's an object of payments, try to find array inside
      for (const k of Object.keys(data)) {
        if (Array.isArray(data[k])) { payments = data[k]; break; }
      }
    }

    // if still empty and original data is array-like, use it
    if (!payments.length && Array.isArray(data)) payments = data;

    currentPayments = payments || [];
    currentPayments.forEach(p => { if(p.artist_submitted===undefined) p.artist_submitted=false; });
    renderTable();
  } catch (err) { console.error("loadPendingPayments error:", err); }
}

function renderTable() {
  const filter = (statusFilter && statusFilter.value) ? statusFilter.value : 'all';
  if (!paymentTable) return;
  paymentTable.innerHTML = "";

  const sorted = currentPayments.slice().sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

  sorted.forEach(p => {
    const statusText = (p.status ? String(p.status) : (p.approved ? 'approved' : 'pending')).toLowerCase();
    if(filter!=='all' && statusText!==filter) return;

    const artworkName = p.artwork_name||"-";
    const artworkCell = p.artwork_url ? `<img class="thumb" src="${p.artwork_url}" onclick="window.open('${p.artwork_url}','_blank')">` : `<div style="width:120px;height:80px;border:1px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#888;">No art</div>`;
    const slipCell = p.slip_url ? `<img class="thumb" src="${p.slip_url}" onclick="window.open('${p.slip_url}','_blank')">` : `<div style="width:120px;height:80px;border:1px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#888;">No slip</div>`;
    const datePart = p.confirmed_at ? new Date(p.confirmed_at).toLocaleString('th-TH') : (p.created_at?new Date(p.created_at).toLocaleString('th-TH'):"-");

    let statusHtml = "";

    if (statusText === "pending") {
      statusHtml = `
        <button class="btn-approve" onclick="approvePayment('${p.id}', this)">Approve</button>
        <button class="btn-failed" onclick="openFailModal('${p.id}')">Failed</button>
      `;
    } else if (statusText === "approved") {
      statusHtml = `<button class="btn-finish" disabled>Approved</button>`;
    } else if (statusText === "failed") {
      const reasonTxt = p.failed_reason ? ` (${escapeHtml(p.failed_reason)})` : "";
      statusHtml = `<div style="color:#ff6b6b;font-weight:bold">Failed <br> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ${reasonTxt}</div>`;

      statusHtml += `
      <div style="margin-top:6px;">
        <button class="btn-approve" onclick="approvePayment('${p.id}', this)">Approve</button>
        <button class="btn-failed" onclick="openFailModal('${p.id}')">Failed</button>
      </div>
      `;

// üî¥ Failed ‡πÉ‡∏´‡∏°‡πà (admin ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)
if (!p.last_thread_role) {
  statusHtml += `<div style="margin-top:6px;">
    <a class="link" href="#" onclick="openThreadPopup('${p.id}')">
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    </a>
  </div>`;
}

// üîµ user ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
else if (p.last_thread_role === "user") {
  statusHtml += `<div style="margin-top:6px;">
    <a class="link" href="#" onclick="openThreadPopup('${p.id}')">
      user ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
    </a>
  </div>`;
}


    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="small">${p.id}</td>
      <td class="small">${p.users?.name ?? "-"}</td>
      <td class="small">${p.users?.email ?? "-"}</td>
      <td class="small">${p.concept || '-'}</td>
      <td class="small">${escapeHtml(artworkName)}</td>
      <td>${artworkCell}</td>
      <td>${slipCell}</td>
      <td class="small">${p.fee || '-'}</td>
      <td class="small">${datePart}</td>
      <td id="status-${p.id}">${statusHtml}</td>
    `;
    paymentTable.appendChild(tr);
  });
}

/* approve endpoint */
async function approvePayment(id, btn) {
  try {
    if (btn) {
      btn.disabled = true;
      btn.innerText = "Processing...";
    }

    // üëâ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const res = await fetch(`${API_BASE}/admin/approve/${encodeURIComponent(id)}`, {
      method: "POST"
    });

    const j = await safeJson(res);

    if (res.ok && j && j.success) {
      
      // üëâ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
      if (btn) {
        btn.disabled = true;
        btn.innerText = "Finished";
        btn.classList.remove("btn-approve");
        btn.classList.add("btn-finish");
      }

      // üëâ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ pending ‡πÉ‡∏´‡∏°‡πà (‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      await loadPendingPayments();

      // üéâ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UserVotes.html)
      // ‡∏´‡∏ô‡πâ‡∏≤ UserVotes.html ‡∏à‡∏∞‡πÑ‡∏õ‡πÇ‡∏´‡∏•‡∏î /payments/approved ‡πÄ‡∏≠‡∏á
      // ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ approve ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß

    } else {
      alert("Approve failed");
      if (btn) {
        btn.disabled = false;
        btn.innerText = "Approve";
      }
      console.error(j);
    }

  } catch (err) {
    console.error("approve error:", err);
    if (btn) {
      btn.disabled = false;
      btn.innerText = "Approve";
    }
  }
}


/* safe json parser in case backend returns non-json */
async function safeJson(res){
  try{ return await res.json(); } catch(e){ return null; }
}

/* FAIL modal handlers */
const failModal = document.getElementById("failModal");
const failPaymentIdEl = document.getElementById("failPaymentId");
const failReasonEl = document.getElementById("failReason");
let currentFailPaymentId = null;

function openFailModal(paymentId){
  currentFailPaymentId=paymentId;
  if (failPaymentIdEl) failPaymentIdEl.innerText=paymentId;
  if (failReasonEl) failReasonEl.value="";
  if (failModal) failModal.style.display="flex";
}

document.getElementById("cancelFail").addEventListener("click",()=>{ if(failModal) failModal.style.display="none"; });

document.getElementById("confirmFail").addEventListener("click",async()=>{
  const reason=failReasonEl.value.trim();
  if(!reason) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
  try{
    const res = await fetch(`${API_BASE}/admin/fail/${encodeURIComponent(currentFailPaymentId)}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({reason})
    });
    const j=await safeJson(res);
    if(res.ok && j && j.success){
      if (failModal) failModal.style.display="none";
      await loadPendingPayments();
    } else{ alert("Failed action failed"); console.error(j); }
  }catch(err){ console.error("admin/fail error:",err); }
});

/* Thread popup */
const threadModal=document.getElementById("threadModal");
const threadContent=document.getElementById("threadContent");
if (document.getElementById("closeThread")) document.getElementById("closeThread").addEventListener("click",()=>{ if(threadModal) threadModal.style.display="none"; });

async function openThreadPopup(paymentId){
  try{
    const res = await fetch(`${API_BASE}/admin/failure/${encodeURIComponent(paymentId)}`);
    const j = await safeJson(res);
    // Accept different response shapes
    const threads = (j && j.threads) ? j.threads : (Array.isArray(j) ? j : (j && j.data ? j.data : []));
    if(!Array.isArray(threads)){
      console.error('unexpected threads response', j);
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• thread ‡πÑ‡∏î‡πâ');
      return;
    }

    threadContent.innerHTML = "";

    threads.forEach(t => {
      const dt = t.created_at ? new Date(t.created_at).toLocaleString("th-TH") : '-';
      const role = t.role === 'admin' ? 'Admin' : 'Artist';

      let msgHtml = `<div class="threadItem"><strong>${role}</strong> ‚Äî ${dt}<div style="margin-top:6px;">${escapeHtml(t.message||'')}</div>`;

      try {
        const atts = Array.isArray(t.attachments) ? t.attachments : JSON.parse(t.attachments || "[]");
        if(atts && atts.length){
          let attHtml = '<div class="threadAttachments" style="margin-top:6px;">';
          for(const a of atts){
            attHtml += `<a href="${a}" target="_blank"><img src="${a}" class="thumb"/></a>`;
          }
          attHtml += '</div>';
          msgHtml += attHtml;
        }
      } catch(e){ console.error("parse attachments error:", e); }

      msgHtml += '</div>';
      threadContent.innerHTML += msgHtml;
    });

    if (threadModal) threadModal.style.display = "flex";
  } catch(err){ console.error(err); }
}

/* ========== Board Contest JS ========== */

const feeButtons = document.getElementById('feeButtons');
let selectedFee = null;
if (feeButtons) {
  feeButtons.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-val]');
    if (!btn) return;
    Array.from(feeButtons.querySelectorAll('button')).forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    selectedFee = btn.getAttribute('data-val');
  });
}

const bc_bg_input = document.getElementById('bc_bg_input');
let bc_bg_file = null;
if (bc_bg_input) bc_bg_input.addEventListener('change', (e) => {
  bc_bg_file = e.target.files && e.target.files[0] ? e.target.files[0] : null;
});

if (document.getElementById('generateSample')) document.getElementById('generateSample').addEventListener('click', async () => {
  const concept = document.getElementById('bc_concept').value || '(no concept)';
  const fee = selectedFee || '-';
  const openFrom = document.getElementById('bc_open_from').value || '-';
  const openTo = document.getElementById('bc_open_to').value || '-';
  const voteFrom = document.getElementById('bc_vote_from').value || '-';
  const voteTo = document.getElementById('bc_vote_to').value || '-';
  const resultDate = document.getElementById('bc_result_date').value || '-';

  const preview = document.getElementById('bc_preview');
  const overlay = document.getElementById('bc_preview_overlay');

  if (bc_bg_file) {
    const url = URL.createObjectURL(bc_bg_file);
    preview.style.backgroundImage = `url('${url}')`;
  } else {
    preview.style.backgroundImage = '';
  }

  overlay.innerHTML = `
    <div style="font-weight:700; font-size:18px; margin-bottom:8px;">Concept ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î : ${escapeHtml(concept)}</div>
    <div>‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ : ${escapeHtml(String(fee))}</div>
    <div style="margin-top:8px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${escapeHtml(openFrom)} - ${escapeHtml(openTo)}</div>
    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï: ${escapeHtml(voteFrom)} - ${escapeHtml(voteTo)}</div>
    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•: ${escapeHtml(resultDate)}</div>
  `;

  preview.style.display = 'block';
  preview.scrollIntoView({behavior:'smooth'});
});

// upload background to server (returns url)
async function uploadBackgroundFile(file) {
  if (!file) return null;
  const fd = new FormData();
  fd.append('background', file);
  try {
    const res = await fetch(`${API_BASE}/admin/board/uploadBackground`, {
      method: 'POST',
      body: fd
    });
    const j = await safeJson(res);
    if (res.ok && j && j.success && (j.url || j.path)) return j.url || j.path;
    console.error('upload bg failed', j);
    return null;
  } catch (e) { console.error('upload error', e); return null; }
}

if (document.getElementById('createBoard')) document.getElementById('createBoard').addEventListener('click', async () => {
  const concept = document.getElementById('bc_concept').value || '';
  const fee = selectedFee ? Number(selectedFee) : null;
  const openFrom = document.getElementById('bc_open_from').value || '';
  const openTo = document.getElementById('bc_open_to').value || '';
  const voteFrom = document.getElementById('bc_vote_from').value || '';
  const voteTo = document.getElementById('bc_vote_to').value || '';
  const resultDate = document.getElementById('bc_result_date').value || '';
localStorage.setItem("boardPreview", JSON.stringify({
    concept,
    fee,
    openFrom,
    openTo,
    voteFrom,
    voteTo,
    resultDate,

}));
  if (!concept) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Concept ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î');
  if (!fee) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£');

  let bgUrl = null;
  if (bc_bg_file) {
    bgUrl = await uploadBackgroundFile(bc_bg_file);
    if (!bgUrl) {
      if (!confirm('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ background ‡πÑ‡∏î‡πâ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    }
  }

const payload = {
    concept,
    fee,
    open_from: openFrom,
    open_to: openTo,
    vote_from: voteFrom,
    vote_to: voteTo,
    result_date: resultDate,
    bg_url: bgUrl,  // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

};


  try {
    const res = await fetch(`${API_BASE}/admin/board/create`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await safeJson(res);
    if (res.ok && j && j.success) {
      alert('Create board ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      document.getElementById('bc_concept').value=''; Array.from(feeButtons.querySelectorAll('button')).forEach(b=>b.classList.remove('active')); selectedFee=null;
      document.getElementById('bc_open_from').value=''; document.getElementById('bc_open_to').value='';
      document.getElementById('bc_vote_from').value=''; document.getElementById('bc_vote_to').value='';
      document.getElementById('bc_result_date').value='';
      document.getElementById('bc_bg_input').value = '';
      bc_bg_file = null;
      document.getElementById('bc_preview').style.display = 'none';
      await loadBoards(); // refresh boards table
    } else {
      console.error(j); alert('Create board failed (‡∏î‡∏π console)'); 
    }
  } catch (e) { console.error(e); alert('Create board error'); }
});

// --- load boards and render table ---
// global variable (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á <script> ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)


/* ---------------------
   loadBoards (‡πÉ‡∏´‡∏°‡πà)
   --------------------- */


// --- delete board ---
async function deleteBoard(id){
  console.log("üìå deleteBoard() ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å id =", id);
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÄ‡∏≠‡∏≤ preview ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Home ‡∏î‡πâ‡∏ß‡∏¢')) return;
  try{
    const res = await fetch(`${API_BASE}/admin/board/${encodeURIComponent(id)}`, { method: 'DELETE' });
    const j = await safeJson(res);
    if(res.ok && j && j.success){
      alert('‡∏•‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

      // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å local arrays (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      boardsData = boardsData.filter(b => String(b.id) !== String(id));
      // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ openVoteData ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢ (optional)
      try{ if (typeof openVoteData !== 'undefined') openVoteData = openVoteData.filter(b => String(b.id) !== String(id)); }catch(e){}

      renderBoardsTable();
    } else {
      console.error(j); alert('‡∏•‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }catch(e){ console.error('deleteBoard error', e); alert('‡∏•‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
}
document.addEventListener('DOMContentLoaded', async () => {
  await Promise.all([
    loadPendingPayments(),
    loadBoards(),
    loadGalleryFromServer() // ‚úÖ ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà"
  ]);
});


/* ========== init ========== */
refreshBtn && refreshBtn.addEventListener("click",loadPendingPayments);
statusFilter && statusFilter.addEventListener("change",renderTable);

// ‡∏ã‡πà‡∏≠‡∏ô Board ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
document.getElementById("boardSection").style.display = "none";
document.querySelector("h3[style='margin-top:20px;']").style.display = "none"; 
document.querySelector("#boardsTable").closest("table").style.display = "none";

function showContent() {
  // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Approve Payment
  document.querySelector(".controls").style.display = "none";
  document.querySelector("#paymentTable").closest("table").style.display = "none";

  // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Board Contest
  document.getElementById("boardSection").style.display = "block";

  const boardTitle = document.querySelector("h3[style='margin-top:20px;']");
  const boardTable = document.querySelector("#boardsTable").closest("table");

  boardTable.style.display = "table";

  loadBoards();
}
function goBack() {
  // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Approve Payment
  document.querySelector(".controls").style.display = "block";
  document.querySelector("#paymentTable").closest("table").style.display = "table";

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Board Contest
  document.getElementById("boardSection").style.display = "none";

  const boardTitle = document.querySelector("h3[style='margin-top:20px;']");
  const boardTable = document.querySelector("#boardsTable").closest("table");

  
  boardTable.style.display = "none";
}



async function loadBoardsTable() {
    const res = await fetch("http://gen-ai-cypher.onrender.com/boards");
    const boards = await res.json();

    const table = document.querySelector("#boardsTable tbody");
    table.innerHTML = "";

    boards.forEach(b => {
        table.innerHTML += `
            <tr id="row-${b.id}">
              <td>${b.concept}</td>
              <td>${b.fee}</td>
              <td>${b.open_from} - ${b.open_to}</td>
              <td>${b.vote_from} - ${b.vote_to}</td>
              <td>${b.result_date}</td>
              <td>${b.created_at}</td>
              <td>
                 <button class="btn-ghost" onclick="deleteBoard('${b.id}')">Delete</button>
              </td>
            </tr>
        `;
    });
}
async function loadGalleryFromServer() {
  try {
    const res = await fetch(`${API_BASE}/gallery/list`);
    const j = await safeJson(res);

    if (j && j.success && Array.isArray(j.items)) {
      renderGalleryTable(j.items);
    } else {
      renderGalleryTable([]);
    }
  } catch (err) {
    console.error("loadGalleryFromServer error:", err);
    renderGalleryTable([]);
  }
}

async function uploadBgImage(file) {
  const fileName = `bg_${Date.now()}.png`; // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà

  // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ bucket
  const { data, error } = await supabase.storage
    .from("board-bg")
    .upload(fileName, file);

  if (error) {
    console.error("Upload failed:", error);
    return null;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÅ‡∏ö‡∏ö public
  const { data: publicUrl } = supabase.storage
    .from("board-bg")
    .getPublicUrl(fileName);

  return publicUrl.publicUrl; // ‡∏Ñ‡∏∑‡∏ô URL ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô DB
}
/* ===== Open Vote client-side state ===== */
let boardsData = [];        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï (‡∏°‡∏≤‡∏à‡∏≤‡∏Å loadBoards)
let openVoteData = [];      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ Open Vote (client-side)

const openVoteBtn = document.getElementById('openVoteBtn');
const closeVoteBtn = document.getElementById('closeVoteBtn');
const openVoteTable = document.getElementById('openVoteTable');
const openVoteTableBody = document.getElementById('openVoteTableBody');
const openVoteTitle = document.getElementById('openVoteTitle');

async function loadBoards() {
  try {
    const res = await fetch(`${API_BASE}/boards`);
    const data = await res.json();

    const list = Array.isArray(data) ? data : (data.data || []);

    const boardsTableBody = document.getElementById("boardsTable");
    const openVoteTableBody = document.getElementById("openVoteTableBody");

    boardsTableBody.innerHTML = "";
    openVoteTableBody.innerHTML = "";

    list.forEach(board => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${board.concept}</td>
        <td>${board.fee}</td>
        <td>${board.open_from} - ${board.open_to}</td>
        <td>${board.vote_from} - ${board.vote_to}</td>
        <td>${board.result_date}</td>
        <td>${new Date(board.created_at).toLocaleString('th-TH')}</td>
        <td>
          <button onclick="openVote('${board.id}')">Open Vote</button>
        </td>
      `;

      // üìå ‡πÅ‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ "‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"
      if (board.vote_status === "open") {
        // ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á OpenVote
        openVoteTableBody.appendChild(tr);
      } else {
        // ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
        boardsTableBody.appendChild(tr);
      }
    });

  } catch (e) {
    console.error("loadBoards error:", e);
  }
}



/* render ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö boardsTable (‡πÅ‡∏ó‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô DOM ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á) */
function renderBoardsTable() {
  const tbody = document.getElementById('boardsTable');
  if (!tbody) return;
  tbody.innerHTML = '';

  boardsData.forEach(b => {
    const created = b.created_at ? new Date(b.created_at).toLocaleString('th-TH') : '-';
    const status = b.vote_status || 'wait_vote';

    let actionButtons = '';
    if (String(status) === 'wait_vote') {
      actionButtons = `<button class="btn-primary" onclick="openVoteBoard('${b.id}')">Open Vote</button>`;
    } 

    const row = document.createElement('tr');
    row.id = `board-row-${b.id}`;
    row.innerHTML = `
      <td>${escapeHtml(b.concept||'')}</td>
      <td>${b.fee ?? '-'}</td>
      <td>${escapeHtml(b.open_from||'')} - ${escapeHtml(b.open_to||'')}</td>
      <td>${escapeHtml(b.vote_from||'')} - ${escapeHtml(b.vote_to||'')}</td>
      <td>${escapeHtml(b.result_date||'')}</td>
      <td class="small">${created}</td>
      <td>
        ${actionButtons}
        <button class="btn-ghost" onclick="deleteBoard('${b.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
  const boardTable = document.querySelector("#boardsTable").closest("table");
  const boardTitle = document.querySelector("h3[style='margin-top:20px;']");
  if (boardsData.length === 0) {
    boardTable.style.display = 'none';
    if (boardTitle) boardTitle.style.display = 'none';
  } else {
    boardTable.style.display = 'table';
    if (boardTitle) boardTitle.style.display = 'block';
  }
}

/* render OpenVoteTable */
function renderOpenVoteTable() {
  if (!openVoteTableBody) return;
  openVoteTableBody.innerHTML = '';

  openVoteData.forEach(b => {
    const created = b.created_at ? new Date(b.created_at).toLocaleString('th-TH') : '-';
    const row = document.createElement('tr');
    row.id = `openvote-row-${b.id}`;
    row.innerHTML = `
      <td>${escapeHtml(b.concept||'')}</td>
      <td>${b.fee ?? '-'}</td>
      <td>${escapeHtml(b.open_from||'')} - ${escapeHtml(b.open_to||'')}</td>
      <td>${escapeHtml(b.vote_from||'')} - ${escapeHtml(b.vote_to||'')}</td>
      <td>${escapeHtml(b.result_date||'')}</td>
      <td class="small">${created}</td>
      <td>
        <button class="btn-ghost" onclick="moveBackBoard('${b.id}')">Move back</button>
      </td>
    `;
    openVoteTableBody.appendChild(row);
  });

  if (openVoteData.length > 0) {
    openVoteTable.style.display = 'table';
    openVoteTitle.style.display = 'block';
    closeVoteBtn.style.display = 'inline-block';
  } else {
    openVoteTable.style.display = 'none';
    openVoteTitle.style.display = 'none';
    closeVoteBtn.style.display = 'none';
  }
}
if (closeVoteBtn) {
  closeVoteBtn.addEventListener('click', closeVoteAllClient);
}
/* ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö client-side) */
function closeVoteAllClient() {
  if (!openVoteData.length) return;
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Open Vote ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Boards ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

  boardsData = boardsData.concat(openVoteData);
  openVoteData = [];

  renderBoardsTable();
  renderOpenVoteTable();
}
/* ====== Open Vote actions (client-side) ====== */

/* ‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å boardsData -> openVoteData (client-side) */
function openVoteAllClient() {
  if (!boardsData.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢');
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Open Vote ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

  // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  openVoteData = openVoteData.concat(boardsData);
  boardsData = [];

  renderBoardsTable();
  renderOpenVoteTable();
}



/* ‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏•‡∏±‡∏ö (‡∏à‡∏≤‡∏Å Open Vote -> Boards) */

/* ---------------------
   API calls to update status
   --------------------- */

/* open vote per-board (call server route and move row client-side) */
async function openVoteBoard(id) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try {
    const res = await fetch(`${API_BASE}/boards/${encodeURIComponent(id)}/openVote`, {
      method: 'POST'
    });
    const j = await safeJson(res);
    if (res.ok && j && j.success) {
      // move client-side: ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å boardsData ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤ openVoteData
      const idx = boardsData.findIndex(b => String(b.id) === String(id));
      let item = null;
      if (idx !== -1) {
        item = boardsData.splice(idx,1)[0];
      }
      // if server returned board, prefer that
      const serverBoard = j.board || item;
      if (serverBoard) openVoteData.unshift(serverBoard);
      renderBoardsTable();
      renderOpenVoteTable();
      alert('‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    } else {
      console.error('openVoteBoard failed', j);
      alert('Open Vote ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏π console)');
    }
  } catch (err) {
    console.error('openVoteBoard exception', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï');
  }
}
async function moveBackBoard(id) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Wait for vote ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

  try {
    const res = await fetch(`${API_BASE}/boards/${encodeURIComponent(id)}/moveBack`, {
      method: 'POST'
    });
    const j = await safeJson(res);

    if (res.ok && j && j.success && j.board) {

      const updated = j.board; // ‚òÖ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å DB

      // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
      // 1) ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å openVoteData
      openVoteData = openVoteData.filter(item => String(item.id) !== String(id));

      // 2) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï boardsData
      const idx = boardsData.findIndex(b => b.id === id);
      if (idx !== -1) {
        boardsData[idx] = updated;
      } else {
        boardsData.unshift(updated);
      }

      // 3) render ‡πÉ‡∏´‡∏°‡πà
      renderBoardsTable();
      renderOpenVoteTable();

      alert('‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      alert('Move back ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }

  } catch (err) {
    console.error('moveBackBoard exception', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö');
  }
}


/* move back per-board (call server route and move row client-side) */
// ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: POST /boards/:id/moveBack


/* ============================
   Open Vote / Move Back
============================ */





document.getElementById("openVoteBtn").addEventListener("click", async () => {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  try {
    const res = await fetch(`${API_BASE}/boards/openVoteAll`, { method: "POST" });
    const j = await safeJson(res);
    if (res.ok && j && j.success) {
      await loadBoards(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å server ‡πÅ‡∏•‡πâ‡∏ß render
      alert("‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    } else {
      console.error('openVoteAll failed', j);
      alert("Open Vote All ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏π console)");
    }
  } catch (err) {
    console.error('openVoteAll exception', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  }
});
/* ===== ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö loadBoards (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ boards ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á) ===== */
async function loadBoards() {
  try {
    const res = await fetch(`${API_BASE}/boards/list`); // /boards/list ‡∏Ç‡∏≠‡∏á server.js ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß
    const j = await safeJson(res);
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô array
    let boards = [];
    if (Array.isArray(j)) boards = j;
    else if (j && Array.isArray(j.boards)) boards = j.boards;
    else if (j && Array.isArray(j.data)) boards = j.data;
    else if (j && j.board) boards = [j.board];
    else if (j && j.success && Array.isArray(j.boards)) boards = j.boards;

// ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
boardsData = [];
openVoteData = [];
galleryData = [];

// ‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ board_state ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
boards.forEach(b => {
  if (b.board_state === "payment") {
    boardsData.push(b);        // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£ / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï
  }
  else if (b.board_state === "open_vote") {
    openVoteData.push(b);      // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏´‡∏ß‡∏ï
  }
  else if (b.board_state === "result") {
    galleryData.push(b);       // ‚úÖ Gallery (‡∏´‡∏•‡∏±‡∏á Collect)
  }
});

// ‚úÖ render ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≤‡∏Å DB ‡∏à‡∏£‡∏¥‡∏á
renderBoardsTable();
renderOpenVoteTable();
renderGalleryTable();

  } catch (e) {
    console.error('loadBoards error', e);
    boardsData = [];
    openVoteData = [];
    renderBoardsTable();
    renderOpenVoteTable();
  }
}
/* --------- Admin: Collect votes (client-side) ---------- */
const collectVotesBtn = document.getElementById('collectVotesBtn');
const galleryTable = document.getElementById('galleryTable');
const galleryTableBody = document.getElementById('galleryTableBody');
const galleryFilter = document.getElementById('galleryFilter');

async function collectVotesAll() {
  if (!confirm('Collect votes ‚Äî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Gallery ?')) return;

  try {
    collectVotesBtn.disabled = true;
    collectVotesBtn.innerText = 'Processing...';

    // 1Ô∏è‚É£ ‡∏™‡∏±‡πà‡∏á backend collect
    const res = await fetch(`${API_BASE}/boards/collect`, { method: 'POST' });
    const j = await safeJson(res);

    if (!res.ok || !j || !j.success) {
      alert('Collect failed');
      console.error(j);
      return;
    }

    // 2Ô∏è‚É£ ‡πÇ‡∏´‡∏•‡∏î Gallery ‡∏à‡∏≤‡∏Å server ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const gRes = await fetch(`${API_BASE}/gallery/list`);
    const gJson = await safeJson(gRes);

    if (gJson && gJson.success && Array.isArray(gJson.items)) {
      renderGalleryTable(gJson.items);
    } else {
      renderGalleryTable([]);
    }

    alert('‚úÖ Collect votes ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');

  } catch (e) {
    console.error(e);
    alert('Collect votes failed');
  } finally {
    collectVotesBtn.disabled = false;
    collectVotesBtn.innerText = 'Collect votes';
  }
}


collectVotesBtn.addEventListener('click', collectVotesAll);

function renderGalleryTable(items) {
  if (!Array.isArray(items)) items = [];
  galleryTableBody.innerHTML = '';

  window._adminGalleryData = items;

  // group by concept
  const groups = {};
  items.forEach(p => {
    const c = (p.concept || '‚Äî').trim();
    if (!groups[c]) groups[c] = [];
    groups[c].push(p);
  });

  const conceptKeys = Object.keys(groups).sort((a,b)=> a.localeCompare(b,'th'));

  // for each group, sort by votes desc, tie by confirmed_at asc
  const finalList = [];
  conceptKeys.forEach(concept=>{
    const arr = groups[concept].slice();
    arr.sort((a,b) => {
      const av = Number(a.count_votes||0), bv = Number(b.count_votes||0);
      if (bv !== av) return bv - av;
      const at = a.confirmed_at ? new Date(a.confirmed_at).getTime() : 0;
      const bt = b.confirmed_at ? new Date(b.confirmed_at).getTime() : 0;
      return at - bt;
    });

    // assign rank
    for (let i=0;i<arr.length;i++){
      arr[i]._rank_in_concept = i+1;
      finalList.push(arr[i]);
    }
  });

  finalList.forEach(p => {
    const user = p.users || {};
    const artworkCell = p.artwork_url ? `<a href="${p.artwork_url}" target="_blank"><img class="thumb" src="${p.artwork_url}"></a>` : '-';
    const slipCell = p.slip_url ? `<a href="${p.slip_url}" target="_blank"><img class="thumb" src="${p.slip_url}"></a>` : '-';
    const winnerText = (p._rank_in_concept === 1) ? `<strong style="color:green;">No.1</strong>` : `No.${p._rank_in_concept}`;

    // prize money: prefer server-provided p.prize_money, else compute client side if board_fee & contestants available
    let prizeMoney = p.prize_money ?? 0;
    if (!prizeMoney && (p.board_fee || p.fee) && p.board_contestants_count) {
      const fee = Number(p.board_fee || p.fee || 0);
      const cnt = Number(p.board_contestants_count || 0);
      const pool = fee * cnt;
      if (p._rank_in_concept === 1) prizeMoney = Math.round(pool * 0.40);
      else if (p._rank_in_concept === 2) prizeMoney = Math.round(pool * 0.15);
      else if (p._rank_in_concept === 3) prizeMoney = Math.round(pool * 0.05);
    }

    // bank info column
    let bankHtml = '';
    if (p._rank_in_concept <= 3) {
      if (user && (user.account_type || user.acc_num || user.promptpay || user.first_name)) {
        bankHtml = `<a class="link" href="#" onclick="openViewBankInfo('${encodeURIComponent(p.id)}')">View info</a>`;
      } else {
        bankHtml = `<button onclick="adminRequestBankInfo('${p.id}')" class="btn-primary">Request bank info</button>`;
      }
    } else bankHtml = '-';

    // evidence column (attach)
    let evidenceHtml = '';
    if (p._rank_in_concept <= 3) {
      if (p.evidence_url) {
        evidenceHtml = `<a href="${p.evidence_url}" target="_blank"><img src="${p.evidence_url}" class="thumb" style="width:80px;height:60px"></a>`;
      } else {
        evidenceHtml = `<button onclick="openAttachEvidenceModal('${p.id}')" class="btn-ghost">Attach evidence</button>`;
      }
    } else evidenceHtml = '-';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="small">${p.user_id}</td>
      <td class="small">${user.email || '-'}</td>
      <td class="small">${user.name || '-'}</td>
      <td class="small">${escapeHtml(p.artwork_name || '-')}</td>
      <td class="small">${escapeHtml(p.concept || '-')}</td>
      <td class="small">${p.fee ?? '-'}</td>
      <td>${artworkCell}</td>
      <td>${slipCell}</td>
      <td class="small">${p.confirmed_at ? new Date(p.confirmed_at).toLocaleString('th-TH') : '-'}</td>
      <td class="small">${p.count_votes ?? 0}</td>
      <td class="small">${winnerText}</td>

      <!-- NEW COLUMNS -->
      <td class="small">${ (p._rank_in_concept <= 3) ? (prizeMoney ? prizeMoney : '-') : '-' }</td>
      <td class="small">${ bankHtml }</td>
      <td class="small">${ evidenceHtml }</td>

      <td><button class="btn-failed" onclick="deleteGalleryItem('${p.id}')">Delete</button></td>
    `;
    galleryTableBody.appendChild(tr);
  });

  if (items.length) {
    galleryTable.style.display = 'table';
    document.getElementById('galleryTitle').style.display = 'block';
  } else {
    galleryTable.style.display = 'none';
    document.getElementById('galleryTitle').style.display = 'none';
  }
}
/* Delete gallery item (just delete payment row or mark as removed?) */
async function deleteGalleryItem(paymentId) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å Gallery / Database ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try {
    // simple delete from Payments
    const res = await fetch(`${API_BASE}/payments/delete/${encodeURIComponent(paymentId)}`, { method: 'DELETE' });
    const j = await safeJson(res);
    if (res.ok && j && j.success) {
      // remove from client array
      window._adminGalleryData = (window._adminGalleryData || []).filter(i => String(i.id) !== String(paymentId));
      renderGalleryTable(window._adminGalleryData);
      alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏π console)');
      console.error(j);
    }
  } catch (err) {
    console.error('deleteGalleryItem error', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  }
}

/* gallery filter */
galleryFilter && galleryFilter.addEventListener('input', (e) => {
  const q = (e.target.value || '').toLowerCase().trim();
  const data = window._adminGalleryData || [];
  if (!q) return renderGalleryTable(data);
  const filtered = data.filter(p => {
    const u = p.users || {};
    return (String(p.user_id||'') + ' ' + (u.email||'') + ' ' + (u.name||'') + ' ' +
      (p.artwork_name||'') + ' ' + (p.concept||'') + ' ' 
    ).toLowerCase().includes(q);
  });
  renderGalleryTable(filtered);
});

// Open view bank info (admin)
function openViewBankInfo(paymentIdEncoded) {
  const paymentId = decodeURIComponent(paymentIdEncoded);
  const data = (window._adminGalleryData || []).find(x => String(x.id) === String(paymentId));
  if (!data) return alert('Data not found');
  const u = data.users || {};
  const html = `
    <div><b>Account type:</b> ${escapeHtml(u.account_type || '-')}</div>
    <div><b>Bank:</b> ${escapeHtml(u.bank || '-')}</div>
    <div><b>Account / Promptpay:</b> ${u.account_type === 'promptpay' ? escapeHtml(u.promptpay || '-') : escapeHtml(u.acc_num || '-')}</div>
    <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</b> ${escapeHtml((u.first_name || '') + ' ' + (u.last_name || ''))}</div>
    <div><b>‡πÇ‡∏ó‡∏£:</b> ${escapeHtml(u.phone || '-')}</div>
  `;
  document.getElementById('bankInfoContent').innerHTML = html;
  document.getElementById('bankInfoModal').style.display = 'flex';
}

async function adminRequestBankInfo(paymentId) {
  if (!paymentId) return alert("missing paymentId");

  const res = await fetch("http://gen-ai-cypher.onrender.com/payments/request-bank-info", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ payment_id: paymentId })
  });

  const data = await res.json();
  console.log("request bank info result:", data);

  if (data.success) {
    alert("Request bank info sent");
  } else {
    alert("Error: " + data.message);
  }
}

// open attach evidence modal
function openAttachEvidenceModal(paymentId) {
  document.getElementById('evidencePaymentId').value = paymentId;
  document.getElementById('evidenceFileInput').value = '';
  document.getElementById('attachEvidenceModal').style.display = 'flex';
}

// upload evidence (admin)
async function uploadEvidenceForPayment() {
  const f = document.getElementById('evidenceFileInput').files[0];
  const pid = document.getElementById('evidencePaymentId').value;
  if (!f) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå');
  const fd = new FormData();
  fd.append('evidence', f);
  fd.append('payment_id', pid);

  try {
    const res = await fetch(`${API_BASE}/payments/upload-evidence`, { method: 'POST', body: fd });
    const j = await safeJson(res);
    if (res.ok && j && j.success) {
      alert('Upload success');
      document.getElementById('attachEvidenceModal').style.display = 'none';
      // refresh gallery
      await loadGalleryFromServer();
    } else {
      console.error(j); alert('Upload failed');
    }
  } catch (e) { console.error(e); alert('Upload failed'); }
}


</script>
</body>
</html>
