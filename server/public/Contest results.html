<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Contest Results</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Prompt', sans-serif;
  background:#0b0f1a;
  margin:0;
  padding:0;
  color:white;
}

/* ========================= NAVBAR ========================= */
.navbar {
  background:#262b3e;
  padding:10px 20px;
  display:flex;
  align-items:center;
  gap:16px;
}

.nav-left {
  display:flex;
  align-items:center;
  gap:10px;
  flex:1;
}

.nav-left a {
  text-decoration:none;
  padding:8px 16px;
  border-radius:8px;
  font-size:15px;
  font-weight:500;
}

/* Home button สีพิเศษ */
.nav-left .home-btn {
  background:#34efe6;
  color:black;
}
.nav-left .home-btn:hover {
  background:#292f3f;
  color:white;
}

/* ปุ่มเมนูทั่วไป */
.nav-left .menu-btn {
  color:white;
}
.nav-left .menu-btn:hover {
  background:#ffffff33;
}

/* ขวาสุด */
.nav-right {
  margin-left:auto;
}

.nav-right a {
  text-decoration:none;
  padding:8px 16px;
  border-radius:8px;
  background:#373d4d;
  color:white;
  font-size:15px;
}

.nav-right a:hover {
  background:white;
  color:#373d4d;
}

.profile-img {
  width:28px;
  height:28px;
  border-radius:50%;
  object-fit:cover;
  margin-right:6px;
  vertical-align:middle;
}

/* ========================= CONTENT ========================= */

.container {
  padding:30px;
  text-align:center;
}

h2 {
  margin-bottom:24px;
  font-size:32px;
  color:#34efe6;
}

/* ===== Card Layout ใหม่แบบภาพแนบ ===== */
.results-grid {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap:26px;
  padding:10px;
}

.card {
  position: relative;
  background: rgba(20,25,40,0.9);
  border-radius: 20px;
  padding: 20px;
  border: 1px solid #1f2a44;
  box-shadow: 0 0 15px rgba(0,255,255,0.18);
  transition: 0.25s;
  cursor: pointer;
  overflow: hidden;
}
/* Overlay ที่จะขึ้นเมื่อเอาเม้าชี้ */
.card::after {
  content: "VIEW GALLERY";
  position: absolute;
  inset: 0;
  background: rgba(20,25,40,0.9);
  color: rgba(255, 255, 255, 0.9);
  font-size: 22px;
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: 0.25s;
  backdrop-filter: blur(3px);
}
.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 0 22px rgba(0,255,255,0.35);
}
.card:hover::after {
  opacity: 1;
} 
.rank-title {
  font-size:26px;
  color:#34efe6;
  font-weight:600;
  margin-bottom:4px;
}

.prize-money {
  font-size:18px;
  margin-bottom:12px;
  color:#8deaff;
}

.card img {
  width:100%;
  height:260px;
  object-fit:cover;
  border-radius:12px;
  border:2px solid #1f2a44;
  box-shadow:0 0 12px rgba(0,255,255,0.25);
}
.view-btn { display:none !important; }
/* ปุ่ม VIEW GALLERY */
.view-btn {
  margin-top:16px;
  padding:10px 18px;
  background:#0cc9e8;
  color:black;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:15px;
  font-weight:600;
  transition:0.2s;
}
.view-btn:hover {
  background:white;
}

/* ========================= MODAL ========================= */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  justify-content:center;
  align-items:center;
  z-index: 9999;
}
/* ========================= MODAL GRID ========================= */
.modal-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 18px;
  margin-top: 16px;
}
.modal-item {
  background: rgba(30,40,60,0.5);
  border-radius: 14px;
  padding: 12px;
  border: 1px solid #1f2a44;
  box-shadow: 0 0 10px rgba(52,239,230,0.15);
}
.modal-item img {
  width: 100%;
  max-height: 180px;
  object-fit: contain;
  border-radius: 10px;
  margin-bottom: 6px;
}
.modal-item .rank {
  font-weight: bold;
  margin-bottom: 6px;
  color: #34efe6;
}
.modal-item .name {
  font-weight: bold;
  margin-top: 4px;
  color: #ffffff;
}
.modal-item .detail {
  font-size: 13px;
  color: #cbd4e0;
}

.modalBox {
  background: rgba(20,25,40,0.9);
  color: #ffffff;
  border-radius: 22px;
  width: 900px;     /* เดิม 520px → ขยาย */
  padding: 24px;
  border: 2px solid #34efe6;
  box-shadow: 0 0 25px rgba(52,239,230,0.4);
  backdrop-filter: blur(6px);
  max-height: 90vh;
  overflow-y: auto;
}


.modalBox img {
  border-radius: 14px;
  border: 2px solid #1f2a44;
  margin-bottom: 10px;
  box-shadow: 0 0 12px rgba(0,255,255,0.25);
}

.modalBox h3 {
  color: #34efe6;
  margin-bottom: 10px;
  font-size: 22px;
}
.closeBtn {
  margin-top: 12px;
  padding: 10px 16px;
  background: #34efe6;
  color: black;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.25s;
}
.closeBtn:hover {
  background: #5ffdf6;
  box-shadow: 0 0 10px rgba(95,253,246,0.6);
}
.winner-name {
  font-size:15px;
  color:#ffffff;
  margin-bottom:6px;
  opacity:0.9;
}

</style>
</head>
<body>

<!-- ========================= NAVBAR ========================= -->
<div class="navbar">

  <div class="nav-left">
    <a href="Home.html" class="home-btn">Home</a>

    <a href="Contest.html" class="menu-btn">Contest</a>
    <a href="Votes.html" class="menu-btn">Votes</a>
    <a href="Contest results.html" class="menu-btn">Contest results</a>
  </div>

  <div class="nav-right" id="authArea"></div>

</div>


<!-- ========================= CONTENT ========================= -->
<div class="container">

<h2>ประกาศรางวัล</h2>
<div id="results" class="results-grid"></div>

</div>


<!-- ========================= MODAL ========================= -->
<div class="modal" id="detailModal">
  <div class="modalBox">
    <h3 id="modalConcept"></h3>
    <div id="allWorks"></div>
    <button class="closeBtn" onclick="closeModal()">ปิด</button>
  </div>
</div>


<script>
const API_BASE = "http://gen-ai-cypher.onrender.com";

async function loadUser() {
  const authArea = document.getElementById("authArea");
  const isLoggedIn = localStorage.getItem("isLoggedIn");
  const userId = localStorage.getItem("currentUserId");

  console.log("DEBUG auth:", { isLoggedIn, userId });

  if (isLoggedIn !== "true" || !userId) {
    authArea.innerHTML = `<a href="SigninAndRegister.html">Sign in / Register</a>`;
    return;
  }

  try {
    const res = await fetch(
      `${API_BASE}/users/info/${encodeURIComponent(userId)}`
    );

    if (!res.ok) throw new Error("profile fetch failed");

    const json = await res.json();
    const user = json.data || json;

    authArea.innerHTML = `
      <a href="Profile.html">
        ${
          user.profile_image
            ? `<img src="${user.profile_image}" class="profile-img">`
            : ""
        }
        Profile : ${user.name || ""}
      </a>
    `;
  } catch (err) {
    console.error("loadUser error:", err);
    authArea.innerHTML = `<a href="SigninAndRegister.html">Sign in / Register</a>`;
  }
}

loadUser();
/* ========================= MODAL ========================= */
function closeModal() {
  document.getElementById("detailModal").style.display = "none";
}

/* ========================= LOAD RESULTS ========================= */
async function loadResults() {
  const titleEl = document.querySelector(".container h2");

    const resultsBox = document.getElementById("results");
  const res = await fetch(`${API_BASE}/gallery/list`);
  const j = await res.json();

  const items = j.items || j || [];

  if (!items.length) {
    titleEl.innerText = "⏳ รอวันประกาศผล ตรวจสอบวันประกาศผลได้ที่หน้า Contest";
    resultsBox.innerHTML = "";
    return;
  }

  // Group by concept
  const groups = {};
  items.forEach(i => {
    if (!groups[i.concept]) groups[i.concept] = [];
    groups[i.concept].push(i);
  });

  resultsBox.innerHTML = "";

  Object.keys(groups).forEach(concept => {
    const arr = groups[concept];

    arr.sort((a,b) => (b.count_votes||0)-(a.count_votes||0));

    const fee = Number(arr[0]?.fee || 0);
    const total = arr.length;

    const prize1 = Math.floor(fee * total * 0.40);
    const prize2 = Math.floor(fee * total * 0.15);
    const prize3 = Math.floor(fee * total * 0.05);

    /* ====== Card HTML ใหม่ ====== */
const card = document.createElement("div");
card.className = "card";

card.innerHTML = `
  <h3>${concept}</h3>

  <div class="rank-title">No.1</div>
  <div class="winner-name">${arr[0]?.user_name || "-"}</div>
  <div class="prize-money">${prize1.toLocaleString()} บาท</div>
  ${arr[0]?.artwork_url ? `<img src="${arr[0].artwork_url}">` : ``}

  <div class="rank-title" style="margin-top:20px;">No.2</div>
  <div class="winner-name">${arr[1]?.user_name || "-"}</div>
  <div class="prize-money">${prize2.toLocaleString()} บาท</div>
  ${arr[1]?.artwork_url ? `<img src="${arr[1].artwork_url}">` : ``}

  <div class="rank-title" style="margin-top:20px;">No.3</div>
  <div class="winner-name">${arr[2]?.user_name || "-"}</div>
  <div class="prize-money">${prize3.toLocaleString()} บาท</div>
  ${arr[2]?.artwork_url ? `<img src="${arr[2].artwork_url}">` : ``}
`;

card.onclick = () => {
  document.getElementById("modalConcept").innerText = concept;

const box = document.getElementById("allWorks");
box.innerHTML = `<div class="modal-grid"></div>`;

const grid = box.querySelector(".modal-grid");

arr.forEach((item, index) => {
grid.innerHTML += `
  <div class="modal-item">
    <div class="rank">
      อันดับ ${index + 1} (${item.count_votes || 0} โหวต)
    </div>
    <img src="${item.artwork_url}">
    <div class="name">${item.user_name || "-"}</div>
    <div class="detail">${item.artwork_name || "-"}</div>
  </div>
`;

});



  document.getElementById("detailModal").style.display = "flex";
};

    resultsBox.appendChild(card);
  });
}

loadUser();
loadResults();
</script>

</body>
</html>
