<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Contest ‚Äì Home</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  body {
  font-family: 'Prompt', sans-serif;
  margin: 0;
  background: #1f2230;
}

/* ---------------- NAVBAR ---------------- */
.navbar {
  background: #262b3e;
  padding: 14px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 999;
  flex-wrap: wrap;
  gap: 10px;
}

.menu-left,
.menu-right {
  display: flex;
  align-items: center;
  gap: 18px;
  flex-wrap: wrap;
}

/* HOME BUTTON */
.btn-home {
  background: #3bc0b9;
  color: black;
  padding: 8px 18px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
}

.menu-left a {
  text-decoration: none;
  color: white;
  font-weight: 500;
  padding: 6px;
}

.btn-right {
  background: #373d4d;
  color: white;
  padding: 8px 18px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.profile-pic {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  object-fit: cover;
}

/* ---------------- CONTENT ---------------- */
.container {
  max-width: 1300px;
  margin: auto;
  padding: 20px;
}

/* CARD CONTAINER */
#homeBoardsContainer {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
}

/* CARD */
.home-board-preview {
  flex: 0 0 calc(25% - 20px); /* Desktop 4 ‡πÉ‡∏ö */
  max-width: calc(25% - 20px);
  background: white;
  height: 640px;
  display: flex;
  flex-direction: column;
  position: relative;
  cursor: pointer;
}

/* IMAGE */
.preview-img {
  width: 100%;
  height: 360px;
  background-size: cover;
  background-position: center;
  position: relative;
}

/* FEE BAR */
.preview-fee {
  position: absolute;
  top: 0;
  right: 0;
  width: 64px;
  height: 15%;
  background: #2a2f45;
  color: white;
  display: flex;
  justify-content: center;
  padding-top: 20px;
  font-weight: 600;
}

/* INFO */
.preview-info {
  background: #2a2f45;
  color: white;
  padding: 16px;
  font-size: 14px;
  flex: 1;
}

/* HOVER */
.preview-hover-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.7);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  font-weight: 600;
  opacity: 0;
  transition: 0.25s;
}

.home-board-preview:hover .preview-hover-overlay {
  opacity: 1;
}

/* ---------------- POPUP ---------------- */
.popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(78,79,80,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.popup-box {
  background: rgba(23,39,56,0.9);
  padding: 24px;
  width: 500px;
  max-width: 90%;
  border-radius: 10px;
  color: white;
  text-align: center;
}

.popup-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.popup-buttons button {
  padding: 10px 18px;
  background: #34efe6;
  border: none;
  border-radius: 6px;
  font-weight: 600;
}

/* ===============================
   üì± RESPONSIVE
================================ */

/* Tablet */
@media (max-width: 1024px) {
  .home-board-preview {
    flex: 0 0 calc(50% - 20px); /* 2 ‡πÉ‡∏ö */
    max-width: calc(50% - 20px);
  }
}

/* Mobile */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    align-items: flex-start;
  }

  .home-board-preview {
    flex: 0 0 100%;
    max-width: 100%;
    height: auto;
  }

  .preview-img {
    height: 260px;
  }

  .preview-fee {
    width: 52px;
    font-size: 14px;
  }

  .preview-info {
    font-size: 13px;
  }

  .popup-box {
    width: 90%;
  }
}

</style>
</head>

<body>
<!-- CUSTOM POPUP -->
<div id="popupOverlay" class="popup-overlay">
  <div class="popup-box">
    <div id="popupMessage" class="popup-message"></div>
    <div class="popup-buttons">
      <button id="popupOk">OK</button>
      <button id="popupCancel" style="display:none;">Cancel</button>
    </div>
  </div>
</div>
<!-- ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ NAVBAR ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ -->
<div class="navbar">
  <div class="menu-left">
    <a class="btn-home" href="Home.html" >Home</a>
    <a href="Contest.html">Contest</a>
    <a href="Votes.html">Votes</a>
    <a href="Contest results.html">Contest results</a>
  </div>

  <div id="menuRight" class="menu-right"></div>
</div>

<!-- ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ CONTENT ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ -->
<div class="container">
  <div id="homeBoardsContainer"></div>
</div>

<script>
const API_BASE = "http://localhost:3000";

/* -------- Prize Calculation -------- */
function calcPrize(fee, count) {
  const total = fee * count;
  return {
    total,
    first: Math.floor(total * 0.40),
    second: Math.floor(total * 0.15),
    third: Math.floor(total * 0.05)
  };
}

/* -------- Load Navbar Right Side -------- */
/* -------- Load Navbar Right Side -------- */
async function loadNavbar() {
  const userId = localStorage.getItem("currentUserId");
  const box = document.getElementById("menuRight");
  box.innerHTML = "";

  // ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login
  if (!userId) {
    box.innerHTML = `
      <a class="btn-right" href="SigninAndRegister.html">
        Sign in / Register
      </a>
    `;
    return;
  }

  // ‚úÖ login ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å DB
  try {
    const res = await fetch(`${API_BASE}/users/info/${encodeURIComponent(userId)}`);
    const json = await res.json();

    if (!json.success) throw new Error("load user failed");

    const name = json.data?.name || "User";
    const image = json.data?.profile_image;

    box.innerHTML = `
      <a class="btn-right" href="Profile.html">
        ${image ? `<img src="${image}" class="profile-pic">` : ""}
        Profile : ${name}
      </a>
    `;
  } catch (err) {
    console.error(err);

    // fallback ‡∏ñ‡πâ‡∏≤ fetch ‡∏û‡∏±‡∏á
    box.innerHTML = `
      <a class="btn-right" href="SigninAndRegister.html">
        Sign in / Register
      </a>
    `;
  }
}


/* -------- Load Contest Boards -------- */
async function loadHomeBoards() {
  try {
    const res = await fetch(`${API_BASE}/boards/list?open_vote=false&board_state=payment`);
    const result = await res.json();
    const boards = result.boards || [];

    const cont = document.getElementById("homeBoardsContainer");
    cont.innerHTML = "";

    const filteredBoards = boards.filter(b => {
      return b.open_vote === false && String(b.board_state).toLowerCase() === "payment";
    });

    if (filteredBoards.length === 0) {
      cont.innerHTML = `<div style='color:white;text-align:center;'>‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>`;
      return;
    }

    filteredBoards.forEach(b => {
      const count = Number(b.contestants_count || 0);
      const fee = Number(b.fee || 0);
      const prize = calcPrize(fee, count);

      const card = document.createElement("div");
      card.className = "home-board-preview";
      card.onclick = () => selectBoard(b);

card.innerHTML = `
  <div class='preview-img' style="background-image:url('${b.bg_url || ""}")">
    <div class='preview-fee'>${fee}‡∏ø</div>
  </div>

  <div class='preview-info'>
    <div>Contest concept : <strong>${b.concept}</strong></div>

    <!-- ‚ñ¨‚ñ¨‚ñ¨ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î ‚ñ¨‚ñ¨‚ñ¨ -->
    <div>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô : <strong>${count}</strong> ‡∏Ñ‡∏ô</div><br>

<div>‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
    <div>No.1 : ${prize.first}</div>
    <div>No.2 : ${prize.second}</div>
    <div>No.3 : ${prize.third}</div>

    <br>
    <div>Apply from : <br> ${b.open_from} - ${b.open_to}</div>
    <div>Vote : <br> ${b.vote_from} - ${b.vote_to}</div>
    <div>Award Announcement : <br> ${b.result_date}</div>

    <div class="preview-hover-overlay">Apply now</div>
  </div>
`;

      cont.appendChild(card);
    });

  } catch (err) {
    console.error("loadHomeBoards error", err);
  }
}

/* -------- Onclick board -------- */
async function selectBoard(b) {
  const isLoggedIn = localStorage.getItem("isLoggedIn");
  const userId = localStorage.getItem("currentUserId");

  if (!isLoggedIn || !userId) {
    showPopup("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£");
    window.location.href = "SigninAndRegister.html";
    return;
  }

  // Check duplicate
  try {
    const dupRes = await fetch(`${API_BASE}/payments/check-duplicate?user_id=${userId}&concept=${encodeURIComponent(b.concept)}`);
    const dup = await dupRes.json();

    if (dup.isDuplicate) {
      showPopup("‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß 1 User ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
      return;
    }

  } catch (e) {
    showPopup("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ");
    return;
  }

  // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Preview ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö
  localStorage.setItem("contestId", b.id);
  localStorage.setItem("contestPrice", b.fee);
  localStorage.setItem("selectedBoardConcept", b.concept);

  localStorage.setItem("selectedBoardBg", b.bg_url || "");
localStorage.setItem("selectedBoardOpen", b.open_from || "");
localStorage.setItem("selectedBoardTo", b.open_to || "");
localStorage.setItem("selectedBoardVote", b.vote_from || "");
localStorage.setItem("selectedBoardVoteTo", b.vote_to || "");
localStorage.setItem("selectedBoardResult", b.result_date || "");
localStorage.setItem("selectedBoardBg", b.bg_url || "");
localStorage.setItem("selectedBoardConcept", b.concept);
localStorage.setItem("contestPrice", b.fee);

  window.location.href = "Payment.html";
}

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  loadNavbar();
  loadHomeBoards();
});

/* ------- CUSTOM POPUP SYSTEM ------- */

function showPopup(message) {
  return new Promise((resolve) => {
    const overlay = document.getElementById("popupOverlay");
    const msg = document.getElementById("popupMessage");
    const okBtn = document.getElementById("popupOk");
    const cancelBtn = document.getElementById("popupCancel");

    msg.innerHTML = message;
    cancelBtn.style.display = "none";

    overlay.style.display = "flex";

    okBtn.onclick = () => {
      overlay.style.display = "none";
      resolve(true);
    };
  });
}

function showConfirm(message) {
  return new Promise((resolve) => {
    const overlay = document.getElementById("popupOverlay");
    const msg = document.getElementById("popupMessage");
    const okBtn = document.getElementById("popupOk");
    const cancelBtn = document.getElementById("popupCancel");

    msg.innerHTML = message;
    cancelBtn.style.display = "inline-block";

    overlay.style.display = "flex";

    okBtn.onclick = () => {
      overlay.style.display = "none";
      resolve(true);
    };
    cancelBtn.onclick = () => {
      overlay.style.display = "none";
      resolve(false);
    };
  });
}

</script>

</body>
</html>