<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Failed — ส่งข้อมูลเพิ่มเติม</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Prompt',sans-serif;
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#0b0f1f,#11182d);
  color:white;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:40px 16px;
}

/* ==== MAIN CONTAINER ==== */
.container{
  width:100%;
  max-width:820px;
  background:rgba(16,26,44,0.75);
  backdrop-filter:blur(8px);
  border-radius:20px;
  padding:26px;
  border:1px solid rgba(52,239,230,0.35);
  box-shadow:0 0 30px rgba(52,239,230,0.25);
}

/* ==== HEADER ==== */
h2{
  margin:0 0 12px;
  color:#ff6b6b;
  text-shadow:0 0 10px rgba(255,107,107,0.6);
}

/* ==== FAIL REASON ==== */
.failReason{
  background:rgba(255,77,79,0.12);
  border:1px solid rgba(255,77,79,0.45);
  border-radius:14px;
  padding:12px 14px;
  margin-bottom:18px;
  font-size:14px;
}

.failReason b{
  color:#ff9a9a;
}

/* ==== FORM ==== */
label{
  display:block;
  margin-top:14px;
  margin-bottom:6px;
  font-weight:500;
  color:#cfd4ff;
}

textarea{
  width:100%;
  min-height:140px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(52,239,230,0.35);
  background:rgba(16,26,44,0.65);
  color:white;
  font-family:'Prompt',sans-serif;
  resize:vertical;
}

textarea:focus{
  outline:none;
  border-color:#34efe6;
  box-shadow:0 0 10px rgba(52,239,230,0.5);
}

/* ==== FILE INPUT ==== */
input[type="file"]{
  background:rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.35);
  padding:10px;
  border-radius:14px;
  color:#cfd4ff;
  width:100%;
}

/* ==== ATTACHMENTS ==== */
.attachments{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:10px;
}

.thumb{
  width:120px;
  height:80px;
  object-fit:cover;
  border-radius:12px;
  border:2px solid rgba(52,239,230,0.5);
  box-shadow:0 0 10px rgba(52,239,230,0.35);
}

/* ==== BUTTON ==== */
.actions{
  margin-top:20px;
  display:flex;
  justify-content:flex-end;
}

.btn{
  padding:10px 22px;
  border-radius:14px;
  border:none;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(135deg,#ff4d4f,#ff7875);
  color:white;
  box-shadow:0 0 14px rgba(255,77,79,0.6);
  transition:0.25s;
}

.btn:hover{
  background:linear-gradient(135deg,#ff7875,#ff9a9a);
  transform:translateY(-2px);
  box-shadow:0 0 20px rgba(255,120,120,0.9);
}
</style>
</head>
<body>
<div class="container">
  <h2>ส่งข้อมูลเพิ่มเติมสำหรับการยืนยัน</h2>

  <div class="small">เหตุผลที่ไม่ผ่านการอนุมัติ: <span id="failReasonDisplay"></span></div>

  <label>คำอธิบายเพิ่มเติม / ข้อมูลที่ต้องการส่ง</label>
  <textarea id="userMessage" placeholder="กรุณาใส่ข้อมูล/อธิบายเพิ่มเติม..."></textarea>

  <label>แนบไฟล์ (สูงสุด 10 ไฟล์)</label>
  <input type="file" id="attachmentsInput" accept="image/*" multiple>
  <div class="attachments" id="attachmentsPreview"></div>

  <div style="margin-top:12px; text-align:right;">
    <button class="btn" id="sendBtn">ส่ง</button>
  </div>
</div>

<script>
const API_BASE = "http://gen-ai-cypher.onrender.com";
const paymentId = new URLSearchParams(location.search).get("paymentId");
const userId = localStorage.getItem("currentUserId");

const failReasonDisplay = document.getElementById("failReasonDisplay");
const attInput = document.getElementById("attachmentsInput");
const previewBox = document.getElementById("attachmentsPreview");

// โหลดเหตุผลจาก admin
async function loadInitialReason() {
  if (!paymentId) return;
  try {
    const res = await fetch(`${API_BASE}/admin/failure/${encodeURIComponent(paymentId)}`);
    const j = await res.json();
    if (!j.success) return;
    const threads = j.threads || [];
    const adminMsg = threads.find(t => t.role === 'admin');
    if (adminMsg) failReasonDisplay.innerText = adminMsg.message;
  } catch (err) { console.error(err); }
}
loadInitialReason();

// preview รูปแนบ
attInput.addEventListener("change", () => {
  previewBox.innerHTML = "";
  const files = Array.from(attInput.files).slice(0,10);
  files.forEach(f => {
    const img = document.createElement("img");
    img.className = "thumb";
    img.src = URL.createObjectURL(f);
    previewBox.appendChild(img);
  });
});

// ส่งข้อมูลเพิ่มเติม
document.getElementById("sendBtn").addEventListener("click", async () => {
  const message = document.getElementById("userMessage").value.trim();
  if (!paymentId) return alert("Missing paymentId");
  if (!userId) return alert("Please login first");

  const form = new FormData();
  form.append("payment_id", paymentId);
  form.append("user_id", userId);
  form.append("message", message || "");

  const files = Array.from(attInput.files).slice(0,10);
  files.forEach(f => form.append("attachments", f));

  try {
    const res = await fetch(`${API_BASE}/user/failure/respond`, { method: "POST", body: form });
    const j = await res.json();
    if (res.ok && j.success) {
      alert("ส่งข้อมูลเรียบร้อยแล้ว ผู้ดูแลจะตรวจสอบและแจ้งผลต่อไป");
      window.location.href = "Profile.html"; // กลับหน้า profile
    } else {
      console.error(j);
      alert("ส่งไม่สำเร็จ (ดู console)");
    }
  } catch (err) {
    console.error(err);
    alert("เกิดข้อผิดพลาด");
  }
});
</script>
</body>
</html>
