<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<title>My Profile</title>
<style>
 body {
  font-family: 'Prompt', sans-serif;
  margin: 0;
  background: #0b0f1f;
  color: white;
}

/* ==== FUTURISTIC SCROLLBAR ==== */
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track {
  background: #111725;
  border-radius: 12px;
}
::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #34efe6, #129a91);
  border-radius: 12px;
  box-shadow: 0 0 8px rgba(52,239,230,0.7);
}
::-webkit-scrollbar-thumb:hover {
  background: #5ffdf6;
  box-shadow: 0 0 12px rgba(95,253,246,1);
}

/* ========== NAVBAR ========== */
.navbar {

  background: #131a2f;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1.5px solid rgba(52,239,230,0.5);
  box-shadow: 0 0 15px rgba(52,239,230,0.15);
  padding: 14px 20px;
}

/* ‡∏ã‡πâ‡∏≤‡∏¢ */
.nav-left a {
  margin-right: 28px;
  text-decoration: none;
  font-size: 16px;
  font-weight: 500;
}

/* HOME */
.nav-home {
  background: #34efe6;
  color: black;
  padding: 8px 16px;
  border-radius: 10px;
  transition: 0.25s;
}
.nav-home:hover {
  background:#292f3f;
  color:#34efe6;
}

/* MENU ‡∏õ‡∏Å‡∏ï‡∏¥ */
.nav-item {
  color:#cfd4ff;
  transition:0.25s;
}
.nav-item:hover { color:#34efe6; }

/* ‡∏Ç‡∏ß‡∏≤ */
.nav-auth-btn {
  background:#1d2236;
  padding:6px 16px;
  border-radius:10px;
  color:white;
  display:flex;
  align-items:center;
  gap:10px;
  text-decoration:none;
  transition:0.25s;
  border:1px solid rgba(52,239,230,0.4);
}
.nav-auth-btn:hover {
  background:white;
  color:#111;
}

/* ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Navbar */
.nav-profile-img {
  width:38px; height:38px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #34efe6;
  box-shadow:0 0 8px rgba(52,239,230,0.7);
}

/* ========== PROFILE IMAGE ========= */
#profileImagePreview {
  border:3px solid #34efe6;
  box-shadow:0 0 14px rgba(52,239,230,0.6);
}

/* ========== SECTION HEADERS ========= */
h2, h3 {
  color:#34efe6;
  text-shadow:0 0 8px rgba(52,239,230,0.6);
  padding: 10px;
}

/* ========== ACCOUNT FORM ========== */
#accountForm {
  background: rgba(16,26,46,0.7);
  border: 1px solid rgba(52,239,230,0.3);
  backdrop-filter: blur(6px);
  padding: 20px;
  border-radius: 16px;
  margin-top: 20px;
  display:none;
  color:white;
}

/* ========== MODAL (Glass Style) ========= */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.modalBox {
  background: rgba(18,28,48,0.8);
  border: 1px solid rgba(52,239,230,0.4);
  padding: 20px;
  border-radius: 16px;
  width: 500px;
  max-height: 80vh;
  overflow:auto;
  color:white;
  box-shadow: 0 0 20px rgba(52,239,230,0.35);
}

/* ========== BUTTONS ========= */
button {
  background:#34efe6;
  border:none;
  padding:8px 16px;
  border-radius:10px;
  cursor:pointer;
  color:black;
  font-weight:600;
  transition:0.25s;
}
button:hover {
  background:white;
  color:black;
}

/* ========== CARDS (Glass + Glow) ========== */
.cardBox {
  background: rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.4);
  border-radius:18px;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  box-shadow:0 0 20px rgba(52,239,230,0.18);
  backdrop-filter: blur(4px);
  transition:0.25s;
}
.cardBox:hover {
  transform: translateY(-4px);
  box-shadow:0 0 25px rgba(52,239,230,0.4);
}

.cardThumb {
  width:100%;
  border-radius:14px;
  object-fit:cover;
}

.cardButton {
  width:100%;
  padding:8px 12px;
  background:#1ba3ff;
  border-radius:10px;
  border:none;
  color:white;
  font-weight:600;
  transition:0.25s;
}
.cardButton:hover {
  background:#34efe6;
  color:black;
}

/* ========== THREAD IMAGE ========= */
.threadAttachments img {
  border:2px solid rgba(52,239,230,0.4);
  border-radius:10px;
  width: 100px;
}
.cardButton.adminReply {
  
  background: linear-gradient(135deg, #ff4d4f, #131a2f);
  color: white;
}
.cardButton.adminReply:hover {
  background: linear-gradient(135deg, #ff4d4f, #131a2f);
}
.statusBox {
  background: rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.4);
  border-radius:18px;
  padding:12px;
  box-shadow:0 0 20px rgba(52,239,230,0.18);
  backdrop-filter: blur(4px);
  margin-top:8px;
}

.cardButton {
  width:100%;
  padding:8px 12px;
  background: linear-gradient(135deg, #34efe6, #131a2f);
  border-radius:10px;
  border:none;
  color:white;
  font-weight:600;
  transition:0.25s;
}
.cardButton:hover {
  background:#34efe6;
  color:black;
}

.cardButton.adminReply {
  background: linear-gradient(135deg, #ff4d4f, #131a2f);
  color: white;
}
.cardButton.adminReply:hover {
  background: #ff7875;
}
.winnerBox {
  border: 1.5px solid rgba(52,239,230,0.6);
  border-radius: 14px;
  padding: 10px 14px;
  margin-top: 10px;
  background: rgba(16,26,44,0.55);
  box-shadow: 0 0 14px rgba(52,239,230,0.25);
}

.winnerBox .label {
  color: #34efe6;
  font-weight: 600;
}

.winnerBox .value {
  margin-top: 4px;
  font-size: 15px;
}
/* ===== LOGOUT BUTTON ===== */
.nav-logout-btn {
  background: linear-gradient(135deg, #34efe6, #131a2f);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 10px rgba(255,77,79,0.5);
  transition: 0.25s;
}

.nav-logout-btn:hover {
  background: white;
  color: #131a2f;
  box-shadow: 0 0 14px rgba(255,255,255,0.9);
}

.btn-link {
  display: block; /* ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á container */
  width: 100%;
  padding: 12px 0; /* ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏™‡∏ß‡∏¢ */
  background: linear-gradient(135deg, #34efe6, #131a2f);
  color: #fff;
  text-decoration: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  text-align: center; /* ‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
  cursor: pointer;
  transition: 0.2s;
}
.btn-link:hover {
  background: #05aca3;
}

</style>
</head>
<body>
<div class="navbar">
  <div class="nav-left">
    <a href="Home.html" class="nav-home">Home</a>
    <a href="Contest.html" class="nav-item">Contest</a>
    <a href="Votes.html" class="nav-item">Votes</a>
    <a href="Contest results.html" class="nav-item">Contest results</a>
  </div>

  <div class="nav-right" id="authMenu">
    <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ JS -->
  </div>
</div>

<h2>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
<div style="margin-top:15px; padding: 20px;">
  <img id="profileImagePreview" 
       src="" 
       style="width:120px; height:120px; border-radius:50%; object-fit:cover; background:#ddd;">
</div>

<!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
<!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
<div style="padding: 20px;">
  <button id="profileImageBtn" style="
      background:#34efe6;
      color:#111725;
      border:none;
      padding:8px 16px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
  ">Edit image</button>
  <input type="file" id="profileImageInput" accept="image/*" style="display:none;">
</div>


<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
<div style=" padding-left: 20px;">
  <button onclick="uploadProfileImage()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
</div>


<div style="margin-top:10px; padding: 20px;">
<hr style="margin:20px 0;">
<div style="padding: 20px;" ><b >Username:</b> <span id="profileUsername"></span></div>


<button onclick="toggleProfileTable()">Personal information</button>

<button onclick="showPaymentInfo()" >Payment information</button>
<div id="accountForm" style="display:none;">
  <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>

  <label><input type="radio" name="accType" value="bank" checked > ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
  <label style="margin-left:20px;">
    <input type="radio" name="accType" value="promptpay"> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå
  </label>

  <div style="margin-top:15px; " >
    <label >‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><br>
    <select id="bankSelect" style="padding:6px; width:200px;   background: rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.4);
  border-radius:18px;
  box-shadow:0 0 20px rgba(52,239,230,0.18);
  backdrop-filter: blur(4px);
  transition:0.25s;">
      <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
      <option value="‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
      <option value="‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</option>
    </select>
  </div>

  <div style="margin-top:10px; " >
    <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><br>
    <input id="accNumber" type="text" style="padding:6px; width:250px; color: white;  background: rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.4);
  border-radius:18px;
  box-shadow:0 0 20px rgba(52,239,230,0.18);
  backdrop-filter: blur(4px);
  transition:0.25s; ">
  </div>

  <div style="margin-top:10px;">
    <label>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</label><br>
    <input id="ppNumber" type="text" disabled style="padding:6px; width:250px; color: white;    background: rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.4);
  border-radius:18px;
  box-shadow:0 0 20px rgba(52,239,230,0.18);
  backdrop-filter: blur(4px);
  transition:0.25s;">
  </div>

  <div style="margin-top:10px;">
    <label>‡∏ä‡∏∑‡πà‡∏≠</label><br>
    <input id="firstName" type="text" style="padding:6px; width:250px;  color: white;  background: rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.4);
  border-radius:18px;
  box-shadow:0 0 20px rgba(52,239,230,0.18);
  backdrop-filter: blur(4px);
  transition:0.25s;">
  </div>

  <div style="margin-top:10px;">
    <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><br>
    <input id="lastName" type="text" style="padding:6px; width:250px;   background: rgba(16,26,44,0.65);
  border:1px solid rgba(52,239,230,0.4);
  border-radius:18px;
  box-shadow:0 0 20px rgba(52,239,230,0.18);
  backdrop-filter: blur(4px);
  transition:0.25s;">
  </div>

<div style="margin-top:10px;">
  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><br>
  <input id="phone" type="text"
         style="padding:6px; width:250px; color:white;
         background: rgba(16,26,44,0.65);
         border:1px solid rgba(52,239,230,0.4);
         border-radius:18px;">
</div>



  <button onclick="openConfirmAccount()" 
          style="margin-top:15px; padding:8px 16px; background:#4a76ff; color:white; border:none; border-radius:6px;">
    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  </button>

  <p>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: <span id="bankDisplay">-</span></p>
<p><span id="accDisplay"></span></p>
<p><span id="nameDisplay"></span></p>

</div>
<div id="confirmModal" class="modal">
  <div class="modalBox">
    <h3>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>

    <div style="text-align:right;">
      <button onclick="closeConfirm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button onclick="saveAccountInfo()" 
              style="background:#4a76ff; color:white; padding:6px 12px; border:none; border-radius:6px;">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      </button>
    </div>
  </div>
</div>
</div>
<h3 id="profileTitle" style="margin-top:20px; display:none;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û AI </h3>

<div id="cardsContainer" 
     style="display:none; 
            margin-top:20px; 
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap:50px; padding: 20px;">
</div>



<!-- Pop-up ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
<div id="threadModal" class="modal">
  <div class="modalBox">
    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
    <div id="threadContent"></div>
    <div style="text-align:right;margin-top:8px;">
      <button onclick="closeThread()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>
<!-- Evidence Image Modal -->



<!-- Bank Info Notification Modal -->
<div id="bankNotifyModal" class="modal" style="display:none;">
  <div class="modalBox" style="max-width:420px;text-align:center;">
    <h3>üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h3>
    <p style="margin:12px 0;font-size:15px;">
      ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• <br>
      ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π
      <b>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</b>
    </p>
    <button class="btn-primary" onclick="closeBankNotify()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>


<div id="evidenceModal" class="modal">
  <div class="modalBox" style="max-width:600px;text-align:center;">
    <h3>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
    <img id="evidenceImg"
         style="max-width:100%; border-radius:12px; margin-top:10px;">
    <div style="text-align:right;margin-top:12px;">
      <button onclick="closeEvidence()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>
<script>
const API_BASE = "http://localhost:3000";
const userId = localStorage.getItem("currentUserId");


function escapeHtml(s){
  return s ? s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : "";
}

// Replace loadUserPayments with this enhanced version
async function loadUserPayments(){
  const userId = localStorage.getItem("currentUserId");
  if (!userId) return;

  // 1) load payments (user payment history)
  const res = await fetch(`${API_BASE}/user/payments?user_id=${userId}`);
  const data = await res.json();
  const tbody = document.getElementById("profileTable");

  // 2) load collected gallery items for this user (rank/prize/evidence)
  const gRes = await fetch(`${API_BASE}/gallery/user/${encodeURIComponent(userId)}`);
  const gJson = await gRes.json();
  const galleryItems = (gJson && gJson.items) ? gJson.items : (Array.isArray(gJson) ? gJson : []);

  // build map by payment id for quick lookup
  const galleryMap = {};
  galleryItems.forEach(it => { galleryMap[it.id] = it; });

  data.forEach(p=>{
    const g = galleryMap[p.id] || {};

    const img = p.artwork_url
      ? `<img class="thumb" src="${p.artwork_url}" onclick="window.open('${p.artwork_url}','_blank')">`
      : "-";

    const date = p.confirmed_at
      ? new Date(p.confirmed_at).toLocaleDateString("th-TH")
      : "-";

    let statusHtml="";

    if(p.approved){
      statusHtml = "‚úîÔ∏è Approved";
} else if (p.status === "failed") {

  // üî¥ ‡∏Å‡∏£‡∏ì‡∏µ admin ‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‚Üí user ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
  if (p.last_thread_role === "admin") {
    statusHtml = `
      ‚ùå Failed <br>
      <b>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</b> ${escapeHtml(p.failed_reason || "-")} <br>
<a class="btn-link" href="Failed.html?paymentId=${p.id}" target="_blank">
  ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
</a>



      <br>
      <a class="link" onclick="openThreadPopup('${p.id}')">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</a>
    `;
  }

  // üîµ ‡∏Å‡∏£‡∏ì‡∏µ user ‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‚Üí ‡∏£‡∏≠ admin
  else if (p.last_thread_role === "user") {
    statusHtml = `
      ‚ùå Failed <br>
      admin ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà <br>
      <a class="link" onclick="openThreadPopup('${p.id}')">
        ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (${p.user_response_count})
      </a>
    `;
  }

  // ‚ö™ fallback (‡πÑ‡∏°‡πà‡∏°‡∏µ thread ‡πÄ‡∏•‡∏¢)
  else {
    statusHtml = `
      ‚ùå Failed <br>
      <b>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</b> ${escapeHtml(p.failed_reason || "-")} <br>
<a class="btn-link" href="Failed.html?paymentId=${p.id}" target="_blank">
  ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
</a>

    `;
  }
}
else {
      statusHtml = "‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
    }
    let actionButtonHtml = "";

// ‚ùå Approved ‡∏´‡∏£‡∏∑‡∏≠ ‚è≥ Pending ‚Üí ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
if (!p.approved && p.status !== "pending") {

  // üî¥ admin ‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  if (p.last_thread_role === "admin") {
    actionButtonHtml = `
      <button class="cardButton adminReply" onclick="openThreadPopup('${p.id}')">
        Admin ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
      </button>
    `;
  }

  // üîµ ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô (failed)
  else {
    actionButtonHtml = `
      <button class="cardButton" onclick="openThreadPopup('${p.id}')">
        ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
      </button>
    `;
  }
}


    // gallery derived columns
    const conceptCell = escapeHtml(p.concept || '-');
    const winnerCell = g.rank ? `No.${g.rank}` : '-';
    const prizeCell = g.prize_money ? g.prize_money : '-';
    const countVotesCell = p.count_votes ?? 0;
    const evidenceCell = g.evidence_url ? `<a href="${g.evidence_url}" target="_blank"><img src="${g.evidence_url}" style="width:80px;height:60px;object-fit:cover;border-radius:6px"></a>` : '-';

const cards = document.getElementById("cardsContainer");

const card = document.createElement("div");
card.className = "cardBox";

card.innerHTML = `

    <img class="cardThumb" src="${p.artwork_url || ''}">
    <div class="cardInfo">

    <div class="cardLabel">‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û :${p.artwork_name || "-"}</div>
    <div class="cardValue"></div>

    <div class="cardLabel">Concept :${conceptCell}</div>
    <div class="cardValue"></div>

    <div class="cardLabel">‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ : ${p.fee || "-"}</div>
<div class="cardValue"></div>

<div class="cardLabel">
  ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï : ${p.vote_from || "-"} - ${p.vote_to || "-"}
</div>
<div class="cardValue"></div>

<div class="cardLabel">
  ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏• : ${p.result_date || "-"}
</div>
<div class="cardValue"></div>


    <div class="cardLabel">Count Votes ${countVotesCell} </div>

${g.rank ? `
  <div class="winnerBox">
    <div class="label">üèÜ Winner : ${winnerCell} </div>
    <div class="value"></div>

    <div class="label" style="margin-top:6px;">üí∞ Prize money : ${prizeCell}</div>
    <div class="value"></div>
  </div>
` : ``}






<div class="statusBox">
    <div class="cardLabel">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ : ${statusHtml} </div>
    <div class="cardValue"></div>

${actionButtonHtml}

</div>

${g.evidence_url ? `
  <button class="cardButton"
          onclick="openEvidence('${g.evidence_url}')">
    ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
  </button>
` : ``}
  </div>
`;

cards.appendChild(card);

  });
}


/* ---------- POPUP: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ---------- */
const threadModal = document.getElementById("threadModal");
const threadContent = document.getElementById("threadContent");

function closeThread(){
  threadModal.style.display="none";
}
// check if admin requested bank info for any of user's payments and user missing account -> force open account form
async function adminRequestBankInfo() {
  const userId = localStorage.getItem("currentUserId");
  if (!userId) return;

  // load user's account info
  const infoRes = await fetch(`${API_BASE}/users/info/${encodeURIComponent(userId)}`);
  const infoJson = await infoRes.json();
  if (!infoJson.success) return;
  const u = infoJson.data || {};

  // if user already has account_type + name, we don't force
const hasAccount =
  (u.account_type === "bank" && u.acc_num && u.bank) ||
  (u.account_type === "promptpay" && u.promptpay);

  // load user's payments to see bank_info_requested flag
  const payRes = await fetch(`${API_BASE}/user/payments?user_id=${encodeURIComponent(userId)}`);

  const payJson = await payRes.json();
  const payments = Array.isArray(payJson) ? payJson : (payJson || []);

  const anyRequest = (payments || []).some(p => !!p.bank_info_requested);

  if (anyRequest && !hasAccount) {
    // show account form and prevent navigation until saved
    document.getElementById("accountForm").style.display = "block";
    showBankNotifyModal();

    // prevent closing or navigating away
    window.onbeforeunload = function() { return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ"; };
    // also scroll to form
    document.getElementById("accountForm").scrollIntoView({behavior:'smooth'});
  }
}

window.addEventListener("DOMContentLoaded", () => {
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  loadAccountInfo(); 

  // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å DB
  loadUserProfile();

  const showBankPopup = localStorage.getItem("showBankPopup");
  if (showBankPopup === "true") {
    localStorage.removeItem("showBankPopup");

    document.getElementById("accountForm").style.display = "block";
    showBankNotifyModal();

    window.onbeforeunload = function() {
      return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ";
    };

    document.getElementById("accountForm")
      .scrollIntoView({ behavior: 'smooth' });
  }

  adminRequestBankInfo();
});



async function openThreadPopup(paymentId){
  try{
    const res = await fetch(`${API_BASE}/admin/failure/${paymentId}`);
    const j = await res.json();

    if(!res.ok || !j.success){
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ");
      return;
    }

    const threads = j.threads || [];

    threadContent.innerHTML = "";

    threads.forEach(t=>{
      const dt = new Date(t.created_at).toLocaleString("th-TH");

      let html = `
        <div class="threadItem">
          <strong>${t.role === "admin" ? "Admin" : "‡∏Ñ‡∏∏‡∏ì"}</strong> ‚Äî ${dt}
          <div style="margin-top:6px;">${escapeHtml(t.message)}</div>
          <hr class="white-line-hr">
    <p style="color: white; text-align: center;"></p>
      `;

      const atts = Array.isArray(t.attachments) ? t.attachments : JSON.parse(t.attachments || "[]");

      if(atts.length){
        html += `<div class="threadAttachments" style="margin-top:6px;">`;
        atts.forEach(a=>{
          html += `<a href="${a}" target="_blank"><img src="${a}"></a>`;
        });
        html += `</div>`;
      }

      html += `</div>`;
      threadContent.innerHTML += html;
    });

    threadModal.style.display = "flex";

  }catch(err){
    console.error(err);
  }
}

loadUserPayments();


async function loadProfilePayments() {
  const userId = localStorage.getItem("userId");
  if (!userId) return;

  const res = await fetch(`${API_BASE}/payments/user/${userId}`);
  const list = await res.json();

  const title = document.getElementById("profileTitle");
const cards = document.getElementById("cardsContainer");
  const body = document.getElementById("profileTable");

  title.style.display = "block";
  table.style.display = "table";

  body.innerHTML = "";

  list.forEach(p => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${p.artwork_name || "-"}</td>
      <td><img src="${p.artwork_url || ""}" style="height:60px"></td>
      <td>${p.created_at || "-"}</td>
      <td>${p.approved ? "Approve" : "Pending"}</td>
    `;

    body.appendChild(tr);
  });
}

loadProfilePayments();
async function loadProfileImage() {
  const userId = localStorage.getItem("currentUserId");
  if (!userId) return;

  const res = await fetch(`${API_BASE}/users/info/${userId}`);
  const json = await res.json();
  if (!json.success) return;

  const preview = document.getElementById("profileImagePreview");
  preview.src = `${json.data.profile_image}?v=${Date.now()}`;
  updateNavbarProfile(json.data.name, preview.src);
}
loadProfileImage();
document.getElementById("profileImageBtn").addEventListener("click", function() {
  document.getElementById("profileImageInput").click();
});

document.getElementById("profileImageInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  document.getElementById("profileImagePreview").src = url;
});
async function uploadProfileImage() {
  const file = document.getElementById("profileImageInput").files[0];
  if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô");

  const userId = localStorage.getItem("currentUserId");
  if (!userId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");

  const formData = new FormData();
  formData.append("file", file);
  formData.append("userId", userId);

  try {
    const res = await fetch(`${API_BASE}/upload/profile-image`, {
      method: "POST",
      body: formData
    });

    const j = await res.json();
    if (!res.ok || !j.success) return alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    // ‚úÖ ‡πÉ‡∏ä‡πâ URL ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å response + cache-busting
    const newUrl = `${j.profile_image}?v=${Date.now()}`;
    document.getElementById("profileImagePreview").src = newUrl;
    updateNavbarProfile(j.data.name, newUrl);

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  } catch(err) {
    console.error(err);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
  }
}
async function refreshProfileImage() {
  const userId = localStorage.getItem("currentUserId");
  if (!userId) return;

  try {
    const res = await fetch(`${API_BASE}/users/info/${userId}`);
    const json = await res.json();
    if (!json.success) return;

    const rawUrl = json.data.profile_image || '';
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° cache-busting
    const newUrl = rawUrl ? `${rawUrl}?v=${Date.now()}` : '';

    // update preview
    const preview = document.getElementById("profileImagePreview");
    if (preview) preview.src = newUrl;

    // update Navbar
    updateNavbarProfile(json.data.name, newUrl);

    console.log("REFRESHED IMAGE URL:", newUrl);

  } catch(err) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
  }
}




function toggleProfileTable() {
  // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô
  document.getElementById("cardsContainer").style.display = "grid";
  document.getElementById("profileTitle").style.display = "block";

  // ‚ùå ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  document.getElementById("accountForm").style.display = "none";
}


/* ---- Toggle ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå ---- */
document.querySelectorAll("input[name='accType']").forEach(r => {
  r.addEventListener("change", () => {
    const type = document.querySelector("input[name='accType']:checked").value;

    if (type === "bank") {
      accNumber.disabled = false;
      accNumber.style.background = "rgba(16,26,44,0.65)";

      ppNumber.disabled = true;
      ppNumber.style.background = "#34efe6";
      ppNumber.value = "";
    } 
    else {
      ppNumber.disabled = false;
      ppNumber.style.background = "rgba(16,26,44,0.65)";

      accNumber.disabled = true;
      accNumber.style.background = "#34efe6";
      accNumber.value = "";
    }
  });
});

/* ---------- POPUP ---------- */
function openConfirmAccount(){
  document.getElementById("confirmModal").style.display = "flex";
}

function closeConfirm(){
  document.getElementById("confirmModal").style.display = "none";
}

async function saveAccountInfo() {
  const userId = localStorage.getItem("currentUserId");
  if (!userId) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
    return;
  }

  // --- ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° ---
  const account_type = document.querySelector('input[name="accType"]:checked')?.value;
  const bank = document.getElementById("bankSelect").value;
  const acc_num = document.getElementById("accNumber").value.trim();
  const promptpay = document.getElementById("ppNumber").value.trim();
  const first_name = document.getElementById("firstName").value.trim();
  const last_name = document.getElementById("lastName").value.trim();
  const phone = document.getElementById("phone").value.trim();


  if (!account_type) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
  if (!first_name || !last_name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•");
if (!first_name || !last_name || !phone) {
  alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á");
  return;
}

if (account_type === "bank") {
  if (!bank || !acc_num) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }
}

if (account_type === "promptpay") {
  if (!promptpay) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå");
    return;
  }
}

  // --- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ backend ---
  const body = {
    user_id: userId,
    account_type,
    bank,
    acc_num,
    promptpay,
    first_name,
    last_name,
    phone
  };

  const res = await fetch(`${API_BASE}/user/update-account`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const json = await res.json();

  if (!json.success) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(json.error);
    return;
  }

  // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ---
  const infoRes = await fetch(`${API_BASE}/users/info/${userId}`);
  const infoJson = await infoRes.json();

  if (!infoJson.success) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    return;
  }

  const u = infoJson.data;

  document.getElementById("bankDisplay").innerText = u.bank || "-";
  document.getElementById("accDisplay").innerText =
    u.account_type === "promptpay"
      ? `PromptPay: ${u.promptpay}`
      : `${u.bank}: ${u.acc_num}`;
  document.getElementById("nameDisplay").innerText = `${u.first_name} ${u.last_name}`;

  closeConfirm();
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  // clear navigation block so user can leave
window.onbeforeunload = null;

}
// after closeConfirm(); alert...
window.onbeforeunload = null;

async function loadAccountInfo() {
  const userId = localStorage.getItem("currentUserId");
  if (!userId) return;

  const res = await fetch(`${API_BASE}/users/info/${userId}`);
  const json = await res.json();

  if (!json.success) return;

  const u = json.data;

  document.getElementById("bankDisplay").innerText = u.bank || "-";

  if (u.account_type === "promptpay") {
    document.getElementById("accDisplay").innerText = `PromptPay: ${u.promptpay}`;
  } else {
    document.getElementById("accDisplay").innerText = `${u.bank}: ${u.acc_num}`;
  }

  document.getElementById("nameDisplay").innerText = `${u.first_name} ${u.last_name}`;
}



function showPersonalInfo() {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô
    document.getElementById("profileTitle").style.display = "block";
    document.getElementById("cardsContainer").style.display = "grid";

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    document.getElementById("accountForm").style.display = "none";
}

function showPaymentInfo() {
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô
    document.getElementById("profileTitle").style.display = "none";
    document.getElementById("cardsContainer").style.display = "none";

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    document.getElementById("accountForm").style.display = "block";
}

function closeBankNotify() {
  document.getElementById("bankNotifyModal").style.display = "none";
  localStorage.removeItem("notify_bank_info");
}

// üî• ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const needBankInfo = urlParams.get("needBankInfo");

  if (needBankInfo === "1" && localStorage.getItem("notify_bank_info") === "true") {
    document.getElementById("bankNotifyModal").style.display = "flex";
  }
});

function showBankNotifyModal() {
  const modal = document.getElementById("bankNotifyModal");
  if (modal) modal.style.display = "flex";
}


window.addEventListener("DOMContentLoaded", () => {
  loadAccountInfo();
});

function openEvidence(url) {
  document.getElementById("evidenceImg").src = url;
  document.getElementById("evidenceModal").style.display = "flex";
}

function closeEvidence() {
  document.getElementById("evidenceModal").style.display = "none";
}
async function loadUserProfile() {
  const userId = localStorage.getItem("currentUserId");
  if (!userId) return;

  const res = await fetch(`${API_BASE}/users/info/${userId}`);
  const json = await res.json();

  if (!json.success) return;

  const u = json.data;

  // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å DB
  document.getElementById("profileUsername").innerText = u.name || "-";

  // ‚úÖ Navbar name
  updateNavbarProfile(u.name, u.profile_image);
}
function updateNavbarProfile(name, image) {
  const authMenu = document.getElementById("authMenu");

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° cache-busting ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ image
  const imgUrl = image ? `${image}?v=${Date.now()}` : 'default.png';

  authMenu.innerHTML = `
    <div style="display:flex; align-items:center; gap:10px;">
      <a class="nav-auth-btn" href="Profile.html">
        <img src="${imgUrl}" class="nav-profile-img">
        Profile : ${name || "-"}
      </a>

      <button class="nav-logout-btn" onclick="logout()">
        Logout
      </button>
    </div>
  `;
}

function logout() {
  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  localStorage.removeItem("currentUserId");
  localStorage.removeItem("currentUserEmail");
  localStorage.removeItem("showBankPopup");
  localStorage.removeItem("notify_bank_info");

  // ‡∏Å‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
  sessionStorage.clear();

  // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
  window.location.href = "SigninAndRegister.html";
}

</script>

</body>
</html>
