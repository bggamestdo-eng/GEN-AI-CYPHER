<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contest ‚Äì Votes</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Prompt', sans-serif;
    margin: 0;
    background: #000000;
  }

  /* ---------------- NAVBAR ---------------- */
  .navbar {
    background: #262b3e;
    padding: 14px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 999;
  }

  .menu-left,
  .menu-right {
    display: flex;
    align-items: center;
    gap: 18px;
  }

  .btn-home {
    background: #34efe6;
    color: black;
    padding: 8px 18px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: 0.2s;
  }
  .btn-home:hover {
    background: #292f3f;
    color: white;
  }

  .menu-left a {
    text-decoration: none;
    color: white;
    font-weight: 500;
    transition: 0.25s;
    padding: 8px 6px;
  }
  .menu-left a:hover { opacity: 0.7; }

  .btn-right {
    background: #373d4d;
    color: white;
    padding: 8px 18px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.25s;
  }
  .btn-right:hover { background: white; color: #373d4d; }

  .profile-pic {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
  }

  /* ---------------- SPLIT LAYOUT ---------------- */
  .split-layout {
    display: flex;
    height: calc(100vh - 70px);
  }

  /* LEFT SIDE LIST */
  .left-list {
    width: 340px;
    overflow-y: auto;
    padding: 18px;
  }

  /* RIGHT SIDE (UserVotes.html) */
  .right-view {
    flex: 1;
    border: none;
    background: #111;
    height: 100%;
  }

  /* --------- PREVIEW ITEMS ---------- */
  .home-board-preview {
    display: flex;
    height: 110px;
    margin-bottom: 12px;
    background: #2a2f45;
    cursor: pointer;
    border-radius: 6px;
    overflow: hidden;
    transition: 0.2s;
  }
  .home-board-preview:hover {
    transform: scale(1.02);
  }

  .preview-img {
    width: 110px !important;
    height: 110px !important;
    background-size: cover;
    background-position: center;
  }

  .preview-info {
    flex: 1;
    padding: 12px;
    color: white;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1.4;
  }
  /* ==== CUSTOM SCROLLBAR FOR openBoardsContainer ==== */
#openBoardsContainer::-webkit-scrollbar {
  width: 20px;
}

#openBoardsContainer::-webkit-scrollbar-track {
  background: #1a1f2e; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå */
  border-radius: 20px;
}

#openBoardsContainer::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #34efe6, #16c7bf);
  border-radius: 20px;
  box-shadow: 0 0 8px rgba(52, 239, 230, 0.7);
}

#openBoardsContainer::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #5ffdf6, #34efe6);
  box-shadow: 0 0 12px rgba(95, 253, 246, 0.8);
}

/* Firefox */
#openBoardsContainer {
  scrollbar-width: thin;
  scrollbar-color: #34efe6 #1a1f2e;
}

</style>

</head>

<body>

<div class="navbar">
  <div class="menu-left">
    <a class="btn-home" href="Home.html">Home</a>
    <a href="Contest.html">Contest</a>
    <a href="Votes.html">Votes</a>
    <a href="Contest results.html">Contest results</a>
  </div>

  <div id="menuRight" class="menu-right"></div>
</div>


<!-- üìå LAYOUT: LEFT (list) + RIGHT (UserVotes.html) -->
<div class="split-layout">

  <!-- LEFT LIST -->
  <div class="left-list" id="openBoardsContainer"></div>

  <!-- RIGHT CONTENT -->
  <iframe id="detailFrame" src="" class="right-view"></iframe>

</div>


<script>


/* Sanitizer */
function escapeHtml(str){
  if (!str) return "";
  return str.replace(/[&<>"']/g, m => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
  }[m]));
}

const API_BASE = "http://localhost:3000";


/* ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Open vote */
async function loadBoardsForVote(){
  const res = await fetch(`${API_BASE}/boards/list`);
  let data = [];

  try {
    data = await res.json();
    if (!Array.isArray(data)) data = data.data || data.boards || [];
  } catch { data = []; }

  const openBoards = data.filter(b => String(b.board_state) === "open_vote");
  renderOpenBoards(openBoards);
}


function renderOpenBoards(list){
  const cont = document.getElementById("openBoardsContainer");
  cont.innerHTML = "";

  if (list.length === 0){
    cont.innerHTML = `<div style="color:white; text-align:center;">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Open vote)</div>`;
    return;
  }

  let firstDiv = null;

  list.forEach((b, index) => {
    const div = document.createElement("div");
    div.className = "home-board-preview";

    div.innerHTML = `
      <div class="preview-img" style="background-image:url('${b.bg_url || ""}')"></div>
      <div class="preview-info">
        <div><strong>${escapeHtml(b.concept)}</strong></div>
        <div>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î: ${b.contestants_count ?? 0}</div>
      </div>
    `;

    div.onclick = () => {
      /* ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
      localStorage.setItem("contestId", b.id);
      localStorage.setItem("contestPrice", b.fee);
      localStorage.setItem("selectedConceptForVote", b.concept);

      /* ‡πÇ‡∏´‡∏•‡∏î UserVotes.html */
      document.getElementById("detailFrame").src = "UserVotes.html";
    };

    // üëâ ‡∏à‡∏≥ preview ‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÑ‡∏ß‡πâ
    if (index === 0) {
      firstDiv = div;
    }

    cont.appendChild(div);
  });

  // ‚≠ê AUTO CLICK ‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å
  if (firstDiv) {
    firstDiv.click();
  }
}


async function loadNavbar() {
  const userId = localStorage.getItem("currentUserId");
  const box = document.getElementById("menuRight");

  if (!userId) {
    box.innerHTML = `
      <a class="btn-right" href="SigninAndRegister.html">
        Sign in / Register
      </a>`;
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/users/info/${userId}`);
    const json = await res.json();

    const user = json?.data || json;
    if (!user) throw new Error("no user data");

    box.innerHTML = `
      <a class="btn-right" href="Profile.html">
        ${
          user.profile_image
            ? `<img class="profile-pic" src="${user.profile_image}">`
            : ""
        }
        Profile : ${user.name}
      </a>
    `;
  } catch (err) {
    console.error("loadNavbar error:", err);
    box.innerHTML = `
      <a class="btn-right" href="SigninAndRegister.html">
        Sign in / Register
      </a>`;
  }
}



loadNavbar();

/* ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ */
loadBoardsForVote();
</script>

</body>
</html>
