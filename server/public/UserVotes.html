<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>User Votes</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background: #000000;
      padding: 20px;
      margin: 0;
      color: white;
    }

    /* ---------------- POPUP ---------------- */
    #popupModal {
      position: fixed;
      inset: 0;
      background: rgba(23, 39, 56, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 16px;
    }

    #popupBox {
      background: #1b2538;
      padding: 22px;
      border-radius: 14px;
      width: 100%;
      max-width: 850px;
      max-height: 90vh;
      overflow-y: auto;
      color: white;
      box-shadow: 0 0 15px rgba(52, 239, 230, 0.35);
      border: 2px solid rgba(52, 239, 230, 0.5);
    }

    .popup-btn {
      margin-top: 16px;
      padding: 10px 22px;
      background: #34efe6;
      border: none;
      border-radius: 8px;
      color: black;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .popup-btn:hover {
      background: #2bcbc3;
    }

    /* ---------------- GRID ---------------- */
    #artworkList {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    /* ---------------- CARD ---------------- */
    .art-box {
      background: rgba(20, 25, 40, 0.9);
      padding: 18px;
      border-radius: 18px;
      border: 3px solid #1f2a44;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.18);
      transition: 0.25s;
      cursor: pointer;
      text-align: center;
      color: #34efe6;
      position: relative;
      overflow: hidden;
    }

    .art-box:hover {
      transform: scale(1.03);
      border-color: #34efe6;
    }

    .art-box img {
      width: 100%;
      aspect-ratio: 300/263; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 10px;
    }

    /* ---------------- TEXT ---------------- */
    .title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .vote-btn {
      margin-top: 12px;
      padding: 8px 16px;
      background: #34efe6;
      color: #262b3e;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    /* ---------------- VOTERS ---------------- */
    .voters {
      margin-top: 10px;
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .voter-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #34efe6;
    }

    /* ---------------- OVERLAY ---------------- */
    .art-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      opacity: 0;
      transition: 0.25s;
      border-radius: 15px;
    }

    .art-box:hover .art-overlay {
      opacity: 1;
    }

    /* =========================
       üì± RESPONSIVE
    ========================= */
    @media (max-width: 1024px) {
      #artworkList { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      #artworkList { grid-template-columns: 1fr; }
      #popupBox > div:first-child {
        flex-direction: column !important;
      }
    }
  </style>
</head>

<body>

  <h2 style="color:#ffffff;">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î</h2>
  <div id="conceptTitle" style="margin-bottom:8px; font-weight:600; color:#34efe6; font-size: 20px;"></div>
  
  <div id="prizeBox" style="margin-bottom:18px; padding: 15px; background: rgba(52,239,230,0.1); border-radius: 10px; display: inline-block;">
    </div>

  <div id="artworkList">
    <div style="color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div id="popupModal">
    <div id="popupBox"></div>
  </div>

  <script>
    const API = "https://gen-ai-cypher.onrender.com";
    const currentUserId = localStorage.getItem("currentUserId");
    const DEFAULT_AVATAR = "images/Uservote/icon.png";

    /* ---------------- POPUP FUNCTION ---------------- */
    function showPopup(message, showButton = true) {
      const box = document.getElementById("popupBox");
      box.innerHTML = `
        <div style="font-size:18px; margin-bottom:12px; text-align:center;">${message}</div>
        <div style="text-align:center;">
          ${showButton ? `<button class="popup-btn" onclick="closePopup()">‡∏ï‡∏Å‡∏•‡∏á</button>` : ""}
        </div>
      `;
      document.getElementById("popupModal").style.display = "flex";
    }

    function closePopup() {
      document.getElementById("popupModal").style.display = "none";
    }

    /* ---------------- HELPER FUNCTIONS ---------------- */
    async function getUserProfile(userId) {
      try {
        const res = await fetch(`${API}/users/info/${userId}`);
        const json = await res.json();
        return json.data || json;
      } catch (err) {
        return { name: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠" };
      }
    }

    async function loadVoters(paymentId) {
      try {
        const res = await fetch(`${API}/payments/voters/${paymentId}`);
        const json = await res.json();
        return json.data || [];
      } catch {
        return [];
      }
    }

    function calcPrize(fee, count) {
      const total = fee * count;
      return {
        first: Math.floor(total * 0.40).toLocaleString(),
        second: Math.floor(total * 0.15).toLocaleString(),
        third: Math.floor(total * 0.05).toLocaleString()
      };
    }

    /* ---------------- MAIN LOAD FUNCTION ---------------- */
    async function loadApprovedArtworks() {
      try {
        const selectedConcept = localStorage.getItem("selectedConceptForVote");
        document.getElementById("conceptTitle").innerText = selectedConcept ? `Concept: ${selectedConcept}` : "‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏∏‡∏Å Concept";

        const res = await fetch(`${API}/payments/approved`);
        const result = await res.json();

        if (!result.success) {
          showPopup("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          return;
        }

        let list = result.data;
        if (selectedConcept) {
          list = list.filter(item => (item.concept || "").trim() === selectedConcept.trim());
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
        if (list.length > 0) {
          const fee = Number(list[0].fee || 0);
          const prize = calcPrize(fee, list.length);
          document.getElementById("prizeBox").innerHTML = `
            <div style="font-weight:600; color:#34efe6; margin-bottom:5px;">üí∞ ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡∏ö‡∏≤‡∏ó)</div>
            <div>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 : <strong>${prize.first}</strong></div>
            <div>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2 : <strong>${prize.second}</strong></div>
            <div>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 3 : <strong>${prize.third}</strong></div>
          `;
        }

        const container = document.getElementById("artworkList");
        container.innerHTML = "";

        if (list.length === 0) {
          container.innerHTML = `<div style="grid-column: 1/-1; padding:40px; color:#777; text-align:center;">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô Concept ‡∏ô‡∏µ‡πâ</div>`;
          return;
        }

        for (const item of list) {
          const box = document.createElement("div");
          box.className = "art-box";

          // ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô
          const owner = await getUserProfile(item.user_id);
          const ownerName = owner.name || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";

          box.innerHTML = `
            <img src="${item.artwork_url || 'images/placeholder.jpg'}" alt="Artwork">
            <div class="art-overlay">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡πÇ‡∏´‡∏ß‡∏ï</div>
            <div class="title">${item.artwork_name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û)"}</div>
            <div style="font-size:14px; color:#aaa;">‡πÇ‡∏î‡∏¢ ${ownerName}</div>
            <div style="margin-top:6px; color:#34efe6; font-weight:600;">
              ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï : ${item.count_votes || 0}
            </div>
          `;

          box.onclick = () => openDetailPopup(item, ownerName);
          container.appendChild(box);
        }
      } catch (err) {
        showPopup("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        console.error(err);
      }
    }

    /* ---------------- VOTE ACTION ---------------- */
    async function checkUserCanVote(user_id, concept) {
      try {
        const res = await fetch(`${API}/payments/check-vote-right`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id, concept })
        });
        const data = await res.json();
        return data.success && data.canVote === true;
      } catch (err) {
        return false;
      }
    }

    async function handleVote(payment_id, owner_id, concept) {
      if (!currentUserId) {
        showPopup("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏ß‡∏ï");
        return;
      }

      if (currentUserId == owner_id) {
        showPopup("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
        return;
      }

      const canVote = await checkUserCanVote(currentUserId, concept);
      if (!canVote) {
        showPopup("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô Concept ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ");
        return;
      }

      try {
        const res = await fetch(`${API}/payments/vote`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: currentUserId, payment_id })
        });
        const data = await res.json();

        if (data.success) {
          showPopup("‡πÇ‡∏´‡∏ß‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
          loadApprovedArtworks(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
          closePopup();
        } else {
          showPopup(data.msg || "‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      } catch (err) {
        showPopup("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï");
      }
    }

    /* ---------------- DETAIL POPUP ---------------- */
    async function openDetailPopup(item, ownerName) {
      const box = document.getElementById("popupBox");
      const voters = await loadVoters(item.id);

      box.innerHTML = `
        <div style="display:flex; gap:25px; flex-wrap: wrap;">
          <div style="flex:1; min-width:300px;">
            <img src="${item.artwork_url}" style="width:100%; border-radius:12px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
          </div>

          <div style="flex:1; text-align:left; min-width:300px;">
            <h3 style="margin-top:0; color:#34efe6; font-size:24px;">${item.artwork_name}</h3>
            <div style="margin-bottom:12px; color:#ddd;">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô: <strong>${ownerName}</strong></div>
            
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:16px;">
              <div style="font-size:14px; color:#34efe6; margin-bottom:5px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î:</div>
              <div style="font-size:15px; color:#ccc; line-height:1.5;">${item.artwork_detail || item.artworkDetail || "-"}</div>
            </div>

            <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
              <div>
                <div style="font-size:12px; color:#aaa;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                <div style="font-size:24px; font-weight:700; color:#34efe6;">${item.count_votes || 0}</div>
              </div>
              <button class="popup-btn" style="margin-top:0; flex:1;" 
                onclick="handleVote('${item.id}', '${item.user_id}', '${item.concept}')">
                VOTE NOW
              </button>
            </div>

            <div>
              <div style="font-size:14px; color:#aaa; margin-bottom:8px;">‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏´‡∏ß‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</div>
              <div class="voters" style="justify-content: flex-start;">
                ${voters.length > 0 
                  ? voters.map(v => `<img class="voter-avatar" src="${v.profile_image || DEFAULT_AVATAR}" title="${v.name || 'User'}">`).join("")
                  : '<span style="color:#555; font-size:13px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏´‡∏ß‡∏ï</span>'
                }
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:25px; text-align:center; border-top: 1px solid rgba(255,255,255,0.1); pt: 15px;">
          <button class="popup-btn" style="background:#555; color:white;" onclick="closePopup()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      `;
      document.getElementById("popupModal").style.display = "flex";
    }

    /* ---------------- START ---------------- */
    loadApprovedArtworks();
  </script>

</body>
</html>