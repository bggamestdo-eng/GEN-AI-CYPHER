<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>User Votes</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Prompt', sans-serif;
  background: #000000;
  padding: 20px;
  margin: 0;
}

/* ---------------- POPUP ---------------- */
#popupModal {
  position: fixed;
  inset: 0;
  background: rgba(23, 39, 56, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  padding: 16px;
}

#popupBox {
  background: #1b2538;
  padding: 22px;
  border-radius: 14px;
  width: 100%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  color: white;
  box-shadow: 0 0 15px rgba(52,239,230,0.35);
  border: 2px solid rgba(52,239,230,0.5);
}

.popup-btn {
  margin-top: 16px;
  padding: 10px 22px;
  background: #34efe6;
  border: none;
  border-radius: 8px;
  color: black;
  font-weight: 600;
  cursor: pointer;
}

/* ---------------- GRID ---------------- */
#artworkList {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
}

/* ---------------- CARD ---------------- */
.art-box {
  background: rgba(20,25,40,0.9);
  padding: 18px;
  border-radius: 18px;
  border: 3px solid #1f2a44;
  box-shadow: 0 0 15px rgba(0,255,255,0.18);
  transition: 0.25s;
  cursor: pointer;
  text-align: center;
  color: #34efe6;
  position: relative;
}

.art-box:hover {
  transform: scale(1.03);
}

.art-box img {
  width: 100%;
  border-radius: 12px;
  margin-bottom: 10px;
}

/* ---------------- TEXT ---------------- */
.title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 6px;
}

.vote-btn {
  margin-top: 12px;
  padding: 8px 16px;
  background: #34efe6;
  color: #262b3e;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

/* ---------------- VOTERS ---------------- */
.voters {
  margin-top: 10px;
  display: flex;
  gap: 6px;
  justify-content: center;
  flex-wrap: wrap;
}

.voter-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #34efe6;
}

/* ---------------- OVERLAY ---------------- */
.art-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 600;
  color: #ffffff;
  opacity: 0;
  transition: 0.25s;
  border-radius: 18px;
}

.art-box:hover .art-overlay {
  opacity: 1;
}

/* =========================
   üì± RESPONSIVE
========================= */

/* Tablet */
@media (max-width: 1024px) {
  #artworkList {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Mobile */
@media (max-width: 768px) {
  body {
    padding: 12px;
  }

  h2 {
    font-size: 18px;
  }

  #artworkList {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .art-box {
    padding: 14px;
  }

  .title {
    font-size: 16px;
  }

  /* popup layout ‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
  #popupBox > div:first-child {
    display: flex !important;
    flex-direction: column !important;
    gap: 14px !important;
  }

  #popupBox img {
    max-height: 40vh;
    object-fit: contain;
  }

  .popup-btn {
    width: 100%;
  }
}
</style>
</head>

<body>

<!-- POPUP -->
<div id="popupModal">
  <div id="popupBox"></div>
</div>

<h2 style="color:#ffffff;">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î</h2>
<div id="conceptTitle" style="margin-bottom:8px; font-weight:600; color:#ffffff;"></div>
<div id="prizeBox" style="margin-bottom:18px;color:#ffffff;"></div>

<div id="artworkList"></div>

<script>
const API = "https://gen-ai-cypher.onrender.com";
const currentUserId = localStorage.getItem("currentUserId");

/* ---------------- POPUP FUNCTION ---------------- */
function showPopup(message, showButton = true) {
  const box = document.getElementById("popupBox");
  box.innerHTML = `
      <div style="font-size:18px; margin-bottom:12px;">${message}</div>
      ${showButton ? `<button class="popup-btn" onclick="closePopup()">OK</button>` : ""}
  `;
  document.getElementById("popupModal").style.display = "flex";
}

function closePopup() {
  document.getElementById("popupModal").style.display = "none";
}

/* ---------------- LOAD APPROVED ARTWORKS ---------------- */
async function loadApprovedArtworks() {
  try {
    const selectedConcept = localStorage.getItem("selectedConceptForVote");

    // ‚≠ê ‡πÅ‡∏™‡∏î‡∏á concept ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    document.getElementById("conceptTitle").innerHTML = 
      selectedConcept ? `Concept: ${selectedConcept}` : "";

    const res = await fetch(`${API}/payments/approved`);
    const result = await res.json();

    if (!result.success) {
      showPopup("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      return;
    }

    let list = result.data;

    if (selectedConcept) {
      list = list.filter(
        item => (item.concept || "").trim() === selectedConcept.trim()
      );
    }
if (list.length > 0) {
  const fee = Number(list[0].fee || 0);
  const prize = calcPrize(fee, list.length);

  document.getElementById("prizeBox").innerHTML = `
    <div style="font-weight:600;">‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
    <div>No.1 : ${prize.first}</div>
    <div>No.2 : ${prize.second}</div>
    <div>No.3 : ${prize.third}</div>
  `;
}

    if (list.length === 0) {
      document.getElementById("artworkList").innerHTML =
        `<div style="padding:20px;color:#777;">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ concept ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>`;
      return;
    }

    const container = document.getElementById("artworkList");
    container.innerHTML = "";

for (const item of list) {
  const box = document.createElement("div");
  box.className = "art-box";

  // üîπ owner name (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
  let ownerName = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
  try {
    const owner = await getUserProfile(item.user_id);
    ownerName = owner.name || ownerName;
  } catch {}

  // ‚úÖ ‡∏ú‡∏π‡∏Å click ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ ownerName ‡πÅ‡∏•‡πâ‡∏ß
  box.onclick = () => openDetailPopup(item, ownerName);

  // üîπ voters
  const DEFAULT_AVATAR = "images/Uservote/icon.png";

  box.innerHTML = `
    <img src="${item.artwork_url || ""}" alt="Artwork">

    <div class="art-overlay">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>

    <div class="title">
      ${item.artwork_name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û)"}
    </div>

    <div style="font-size:14px;color:#aaa;">
      ‡πÇ‡∏î‡∏¢ ${ownerName}
    </div>

<div style="margin-top:12px;">
  Vote score :
  <span
    id="grid-vote-score-${item.id}"
    data-score="${item.count_votes || 0}"
  >
    ${item.count_votes || 0}
  </span>
</div>

  `;
  box.onclick = () => openDetailPopup(item, ownerName);

  container.appendChild(box);
}

  } catch (err) {
    showPopup("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    console.error(err);
  }
}

/* ---------------- CHECK VOTE RIGHT ---------------- */
async function checkUserCanVote(user_id, concept) {
  try {
    const res = await fetch(`${API}/payments/check-vote-right`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id, concept })
    });

    const data = await res.json();
    return data.success && data.canVote === true;
  } catch (err) {
    console.error(err);
    return false;
  }
}

/* ---------------- CLICK VOTE ---------------- */
document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("vote-btn")) return;

  const payment_id = e.target.dataset.id;
  const owner_id   = e.target.dataset.owner;
  const concept    = e.target.dataset.concept;
  const user_id    = currentUserId;

  if (!user_id) {
    showPopup("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏ß‡∏ï");
    return;
  }

  if (user_id === owner_id) {
    showPopup("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡∏†‡∏≤‡∏û AI ‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
    return;
  }

  const canVote = await checkUserCanVote(user_id, concept);

  if (!canVote) {
    showPopup("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ : ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Concept ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï Concept ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ <br> ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Concept ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ ");
    return;
  }

  const res = await fetch(`${API}/payments/vote`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id, payment_id })
  });

  const data = await res.json();

  if (!data.success) {
    showPopup(data.msg || "‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return;
  }
// ===============================
// üî• UPDATE VOTE SCORE (POPUP + GRID)
// ===============================
const popupScoreEl = document.getElementById(`vote-score-${payment_id}`);
const gridScoreEl  = document.getElementById(`grid-vote-score-${payment_id}`);

if (popupScoreEl) {
  let score = Number(popupScoreEl.dataset.score || 0) + 1;
  popupScoreEl.dataset.score = score;
  popupScoreEl.textContent = score;
}

if (gridScoreEl) {
  let score = Number(gridScoreEl.dataset.score || 0) + 1;
  gridScoreEl.dataset.score = score;
  gridScoreEl.textContent = score;
}

// üî• UPDATE VOTE SCORE REALTIME


if (scoreEl) {
  let currentScore = Number(scoreEl.dataset.score || 0);
  currentScore += 1;

  scoreEl.dataset.score = currentScore;
  scoreEl.textContent = currentScore;
}

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï avatar ‡∏ú‡∏π‡πâ‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ


// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï avatar ‡∏ú‡∏π‡πâ‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
const votersDiv = e.target.nextElementSibling; // div.voters
const voters = await loadVoters(payment_id);
const DEFAULT_AVATAR = "images/Uservote/icon.png";

votersDiv.innerHTML = voters.map(v => {
  const avatar = v.profile_image || DEFAULT_AVATAR;
  const name = v.name || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
  return `<img class="voter-avatar" src="${avatar}" title="${name}" alt="${name}">`;
}).join("");


});
async function getUserProfile(userId) {
  const res = await fetch(`${API}/users/info/${userId}`);
  if (!res.ok) throw new Error("profile fetch failed");
  const json = await res.json();
  return json.data || json;
}


async function loadVoters(paymentId) {
  try {
    const res = await fetch(`${API}/payments/voters/${paymentId}`);
    const json = await res.json();
    return json.data || [];
  } catch {
    return [];
  }
}
function calcPrize(fee, count) {
  const total = fee * count;
  return {
    first: Math.floor(total * 0.40),
    second: Math.floor(total * 0.15),
    third: Math.floor(total * 0.05)
  };
}
async function openDetailPopup(item, ownerName) {
  const box = document.getElementById("popupBox");

  const voters = await loadVoters(item.id);
  const DEFAULT_AVATAR = "images/Uservote/icon.png";

  box.innerHTML = `
    <div style="display:flex;gap:20px;max-width:800px;">
      
      <!-- LEFT -->
      <div style="flex:1;">
        <img src="${item.artwork_url}" style="width:100%;border-radius:12px;">
      </div>

      <!-- RIGHT -->
      <div style="flex:1;text-align:left;">
        <h3 style="margin-top:0;color:#34efe6;">
          ${item.artwork_name}
        </h3>

        <div style="margin-bottom:8px;">‡πÇ‡∏î‡∏¢ ${ownerName}</div>

        <div style="font-size:14px;color:#ccc;margin-bottom:16px;">
          ${item.artworkDetail || "-"}
        </div>

        <button class="popup-btn vote-btn"
          data-id="${item.id}"
          data-owner="${item.user_id}"
          data-concept="${item.concept}">
          Vote
        </button>

<div style="margin-top:6px;">
  Vote score :
  <span
    id="popup-vote-score-${item.id}"
    data-score="${item.count_votes || 0}"
  >
    ${item.count_votes || 0}
  </span>
</div>

        <div class="voters" style="margin-top:10px;justify-content:flex-start;">
          ${voters.map(v => {
            const avatar = v.profile_image || DEFAULT_AVATAR;
            const name   = v.name || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
            return `
              <img
                class="voter-avatar"
                src="${avatar}"
                title="${name}"
                alt="${name}"
              >
            `;
          }).join("")}
        </div>
      </div>
    </div>

    <div style="margin-top:20px;text-align:center;">
      <button class="popup-btn" onclick="closePopup()">Close</button>
    </div>
  `;

  document.getElementById("popupModal").style.display = "flex";
}

/* LOAD */
loadApprovedArtworks();
</script>

</body>
</html>
