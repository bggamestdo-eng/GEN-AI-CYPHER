<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Contest – Home</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Prompt', sans-serif;
    margin: 0;
    background: #1f2230;
  }

  /* ---------------- NAVBAR ---------------- */
  .navbar {
    background: #262b3e;
    padding: 14px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 999;
  }

  .menu-left,
  .menu-right {
    display: flex;
    align-items: center;
    gap: 18px;
  }

  /* HOME BUTTON (Active style) */
  .btn-home {
    background: #3bc0b9;
    color: black;
    padding: 8px 18px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: 0.2s;
  }
  .btn-home:hover {
    background: #292f3f;
    color: white;
  }

  /* Left menu normal buttons */
  .menu-left a {
    text-decoration: none;
    color: rgb(255, 255, 255);
    font-weight: 500;
    transition: 0.25s;
    padding: 8px 6px;
  }
  .menu-left a:hover {
    opacity: 0.7;
  }

  /* Right menu button */
  .btn-right {
    background: #373d4d;
    color: white;
    padding: 8px 18px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.25s;
  }
  .btn-right:hover {
    background: white;
    color: #373d4d;
  }

  .profile-pic {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
  }

  /* ---------------- CONTENT ---------------- */
  .container {
    max-width: 1300px;
    margin: auto;
    padding: 20px;
  }

  /* BOARD PREVIEW (Vertical Style) */
.home-board-preview {
  position: relative;
  flex: 0 0 calc(25% - 20px);  /* 4 อันต่อแถว */
  max-width: calc(25% - 20px);
  width: 100%;
  height: 650px;
  background: white;
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
  border-radius: 0;
  overflow: hidden;
  cursor: pointer;
  display: flex;
  flex-direction: column;
}


.preview-fee {
  position: absolute;
  top: 0px;               /* ระยะจากบน (ปรับถ้าต้องการเผื่อขอบ) */
  right: 10px;             /* ระยะจากขวา */
  width: 72px;             /* ความกว้างของแถบ fee (แก้ได้) */
  height: calc(100% - 180px);/* สูงเท่าการ์ด ลบ margin top/bottom 10px */
  background: #2a2f45;        /* สีดำ */
  color: #fff;
  display: flex;
  align-items: flex-start; /* ข้อความเริ่มจากด้านบน */
  justify-content: center;
  padding-top: 8%;       /* ให้ตัวเลข Fee ลงมาจากบนหน่อย */
  box-sizing: border-box;
  border-radius: 0;        /* ไม่มีมุมโค้ง */
  font-weight: 600;
  font-size: 16px;
  text-align: center;
  z-index: 5;              /* ให้อยู่บนสุด */
}

.preview-img {
  width: 100%;
  height: 500%;           /* ปรับให้พอดีกับความสูงรวม (แก้ได้ถ้าต้องการ) */
  background-size: cover;

  position: relative;      /* เพื่อให้ preview-fee ถ้าอยากยึดแค่พื้นที่รูป ก็เป็นไปได้ */
}
  .preview-info {
    background: #2a2f45;
    color: white;
    padding: 18px;
    font-size: 15px;
  }

  .preview-info div {
    margin-bottom: 6px;
  }
  #homeBoardsContainer {
  display: flex;           /* flex เพื่อจัดเป็นแถว */
  flex-wrap: wrap;         /* พับบรรทัดเมื่อเกิน */
  gap: 20px;               /* ระยะห่างระหว่างการ์ด */
  justify-content: center; /* จัดกึ่งกลางแถว */
  padding: 10px 0;
}
/* overlay ที่จะขึ้นเมื่อ hover */
.preview-hover-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);  /* สีดำโปร่ง */
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  font-weight: 600;
  opacity: 0;                 /* ซ่อนก่อน */
  transition: opacity 0.25s ease;
  z-index: 10;                /* ให้อยู่บนสุด */
  pointer-events: none;       /* ไม่บังการคลิก */
}

/* hover ที่การ์ดจะโชว์ overlay */
.home-board-preview:hover .preview-hover-overlay {
  opacity: 1;
}
/* POPUP OVERLAY */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(78, 79, 80, 0.7); /* #252a3d แบบโปร่ง */
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

/* POPUP BOX */
.popup-box {
  background: rgba(23, 39, 56, 0.7);
  padding: 25px;
  width: 500px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  text-align: center;
  color: white;
  font-size: 16px;
  animation: fadeIn 0.25s ease;
  
}

/* MESSAGE */
.popup-message {
  margin-bottom: 25px;
}

/* BUTTONS */
.popup-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.popup-buttons button {
  padding: 10px 18px;
  border: none;
  background: #34efe6;
  color: black;
  font-weight: 600;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.2s;
}

.popup-buttons button:hover {
  background: white;
  color: #2f3447;
}

@keyframes fadeIn {
  from {opacity: 0; transform: scale(0.9);}
  to {opacity: 1; transform: scale(1);}
}

</style>
</head>

<body>
<!-- CUSTOM POPUP -->
<div id="popupOverlay" class="popup-overlay">
  <div class="popup-box">
    <div id="popupMessage" class="popup-message"></div>
    <div class="popup-buttons">
      <button id="popupOk">OK</button>
      <button id="popupCancel" style="display:none;">Cancel</button>
    </div>
  </div>
</div>
<!-- ▬▬▬▬▬ NAVBAR ▬▬▬▬▬ -->
<div class="navbar">
  <div class="menu-left">
    <a class="btn-home" href="Home.html" >Home</a>
    <a href="Contest.html">Contest</a>
    <a href="Votes.html">Votes</a>
    <a href="Contest results.html">Contest results</a>
  </div>

  <div id="menuRight" class="menu-right"></div>
</div>

<!-- ▬▬▬▬▬ CONTENT ▬▬▬▬▬ -->
<div class="container">
  <div id="homeBoardsContainer"></div>
</div>

<script>
const API_BASE = "http://localhost:3000";

/* -------- Prize Calculation -------- */
function calcPrize(fee, count) {
  const total = fee * count;
  return {
    total,
    first: Math.floor(total * 0.40),
    second: Math.floor(total * 0.15),
    third: Math.floor(total * 0.05)
  };
}

/* -------- Load Navbar Right Side -------- */
/* -------- Load Navbar Right Side -------- */
async function loadNavbar() {
  const userId = localStorage.getItem("currentUserId");
  const box = document.getElementById("menuRight");
  box.innerHTML = "";

  // ❌ ยังไม่ login
  if (!userId) {
    box.innerHTML = `
      <a class="btn-right" href="SigninAndRegister.html">
        Sign in / Register
      </a>
    `;
    return;
  }

  // ✅ login แล้ว → ดึงชื่อจาก DB
  try {
    const res = await fetch(`${API_BASE}/users/info/${encodeURIComponent(userId)}`);
    const json = await res.json();

    if (!json.success) throw new Error("load user failed");

    const name = json.data?.name || "User";
    const image = json.data?.profile_image;

    box.innerHTML = `
      <a class="btn-right" href="Profile.html">
        ${image ? `<img src="${image}" class="profile-pic">` : ""}
        Profile : ${name}
      </a>
    `;
  } catch (err) {
    console.error(err);

    // fallback ถ้า fetch พัง
    box.innerHTML = `
      <a class="btn-right" href="SigninAndRegister.html">
        Sign in / Register
      </a>
    `;
  }
}


/* -------- Load Contest Boards -------- */
async function loadHomeBoards() {
  try {
    const res = await fetch(`${API_BASE}/boards/list?open_vote=false&board_state=payment`);
    const result = await res.json();
    const boards = result.boards || [];

    const cont = document.getElementById("homeBoardsContainer");
    cont.innerHTML = "";

    const filteredBoards = boards.filter(b => {
      return b.open_vote === false && String(b.board_state).toLowerCase() === "payment";
    });

    if (filteredBoards.length === 0) {
      cont.innerHTML = `<div style='color:white;text-align:center;'>❌ ยังไม่มีรายการที่เปิดรับสมัคร</div>`;
      return;
    }

    filteredBoards.forEach(b => {
      const count = Number(b.contestants_count || 0);
      const fee = Number(b.fee || 0);
      const prize = calcPrize(fee, count);

      const card = document.createElement("div");
      card.className = "home-board-preview";
      card.onclick = () => selectBoard(b);

card.innerHTML = `
  <div class='preview-img' style="background-image:url('${b.bg_url || ""}")">
    <div class='preview-fee'>${fee}฿</div>
  </div>

  <div class='preview-info'>
    <div>Contest concept : <strong>${b.concept}</strong></div>

    <!-- ▬▬▬ เพิ่มจำนวนผู้เข้าประกวด ▬▬▬ -->
    <div>ผู้เข้าประกวดจำนวน : <strong>${count}</strong> คน</div><br>

<div>เงินรางวัลตอนนี้</div>
    <div>No.1 : ${prize.first}</div>
    <div>No.2 : ${prize.second}</div>
    <div>No.3 : ${prize.third}</div>

    <br>
    <div>Apply from : <br> ${b.open_from} - ${b.open_to}</div>
    <div>Vote : <br> ${b.vote_from} - ${b.vote_to}</div>
    <div>Award Announcement : <br> ${b.result_date}</div>

    <div class="preview-hover-overlay">Apply now</div>
  </div>
`;

      cont.appendChild(card);
    });

  } catch (err) {
    console.error("loadHomeBoards error", err);
  }
}

/* -------- Onclick board -------- */
async function selectBoard(b) {
  const isLoggedIn = localStorage.getItem("isLoggedIn");
  const userId = localStorage.getItem("currentUserId");

  if (!isLoggedIn || !userId) {
    showPopup("กรุณาเข้าสู่ระบบก่อนสมัคร");
    window.location.href = "SigninAndRegister.html";
    return;
  }

  // Check duplicate
  try {
    const dupRes = await fetch(`${API_BASE}/payments/check-duplicate?user_id=${userId}&concept=${encodeURIComponent(b.concept)}`);
    const dup = await dupRes.json();

    if (dup.isDuplicate) {
      showPopup("❌ คุณสมัครรายการนี้แล้ว 1 User สมัครได้ 1 ครั้งเท่านั้น");
      return;
    }

  } catch (e) {
    showPopup("ไม่สามารถตรวจสอบการสมัครได้");
    return;
  }

  // ⭐ เก็บข้อมูล Preview แบบครบ
  localStorage.setItem("contestId", b.id);
  localStorage.setItem("contestPrice", b.fee);
  localStorage.setItem("selectedBoardConcept", b.concept);

  localStorage.setItem("selectedBoardBg", b.bg_url || "");
localStorage.setItem("selectedBoardOpen", b.open_from || "");
localStorage.setItem("selectedBoardTo", b.open_to || "");
localStorage.setItem("selectedBoardVote", b.vote_from || "");
localStorage.setItem("selectedBoardVoteTo", b.vote_to || "");
localStorage.setItem("selectedBoardResult", b.result_date || "");
localStorage.setItem("selectedBoardBg", b.bg_url || "");
localStorage.setItem("selectedBoardConcept", b.concept);
localStorage.setItem("contestPrice", b.fee);

  window.location.href = "Payment.html";
}

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  loadNavbar();
  loadHomeBoards();
});

/* ------- CUSTOM POPUP SYSTEM ------- */

function showPopup(message) {
  return new Promise((resolve) => {
    const overlay = document.getElementById("popupOverlay");
    const msg = document.getElementById("popupMessage");
    const okBtn = document.getElementById("popupOk");
    const cancelBtn = document.getElementById("popupCancel");

    msg.innerHTML = message;
    cancelBtn.style.display = "none";

    overlay.style.display = "flex";

    okBtn.onclick = () => {
      overlay.style.display = "none";
      resolve(true);
    };
  });
}

function showConfirm(message) {
  return new Promise((resolve) => {
    const overlay = document.getElementById("popupOverlay");
    const msg = document.getElementById("popupMessage");
    const okBtn = document.getElementById("popupOk");
    const cancelBtn = document.getElementById("popupCancel");

    msg.innerHTML = message;
    cancelBtn.style.display = "inline-block";

    overlay.style.display = "flex";

    okBtn.onclick = () => {
      overlay.style.display = "none";
      resolve(true);
    };
    cancelBtn.onclick = () => {
      overlay.style.display = "none";
      resolve(false);
    };
  });
}

</script>

</body>
</html>